(window.webpackJsonp=window.webpackJsonp||[]).push([[80],{"+2Nz":function(e,t,a){"use strict";a.r(t);var r=a("Obii"),s=a("LvDl"),n=a("XlPw"),i=a("F/XL"),o=a("p0ib"),l=a("67Y/"),c=a("9Z1F"),u=a("15JJ"),d=a("wZee"),m=a.n(d),h=a("t8hP"),p=a("5kRJ"),g=a("eqT+"),b=a("NPB1"),f=a("m257"),v=a("WM9j"),y=a("BuRe");var x=function(e){if(!Object(y.a)(e))throw TypeError("Invalid UUID");var t,a=new Uint8Array(16);return a[0]=(t=parseInt(e.slice(0,8),16))>>>24,a[1]=t>>>16&255,a[2]=t>>>8&255,a[3]=255&t,a[4]=(t=parseInt(e.slice(9,13),16))>>>8,a[5]=255&t,a[6]=(t=parseInt(e.slice(14,18),16))>>>8,a[7]=255&t,a[8]=(t=parseInt(e.slice(19,23),16))>>>8,a[9]=255&t,a[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,a[11]=t/4294967296&255,a[12]=t>>>24&255,a[13]=t>>>16&255,a[14]=t>>>8&255,a[15]=255&t,a};function j(e,t,a,r){switch(e){case 0:return t&a^~t&r;case 1:return t^a^r;case 2:return t&a^t&r^a&r;case 3:return t^a^r}}function O(e,t){return e<<t|e>>>32-t}var w=function(e,t,a){function r(e,r,s,n){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],a=0;a<e.length;++a)t.push(e.charCodeAt(a));return t}(e)),"string"==typeof r&&(r=x(r)),16!==r.length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var i=new Uint8Array(16+e.length);if(i.set(r),i.set(e,r.length),(i=a(i))[6]=15&i[6]|t,i[8]=63&i[8]|128,s){n=n||0;for(var o=0;o<16;++o)s[n+o]=i[o];return s}return Object(v.a)(i)}try{r.name=e}catch(e){}return r.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",r.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",r}("v5",80,(function(e){var t=[1518500249,1859775393,2400959708,3395469782],a=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var r=unescape(encodeURIComponent(e));e=[];for(var s=0;s<r.length;++s)e.push(r.charCodeAt(s))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var n=e.length/4+2,i=Math.ceil(n/16),o=new Array(i),l=0;l<i;++l){for(var c=new Uint32Array(16),u=0;u<16;++u)c[u]=e[64*l+4*u]<<24|e[64*l+4*u+1]<<16|e[64*l+4*u+2]<<8|e[64*l+4*u+3];o[l]=c}o[i-1][14]=8*(e.length-1)/Math.pow(2,32),o[i-1][14]=Math.floor(o[i-1][14]),o[i-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<i;++d){for(var m=new Uint32Array(80),h=0;h<16;++h)m[h]=o[d][h];for(var p=16;p<80;++p)m[p]=O(m[p-3]^m[p-8]^m[p-14]^m[p-16],1);for(var g=a[0],b=a[1],f=a[2],v=a[3],y=a[4],x=0;x<80;++x){var w=Math.floor(x/20),_=O(g,5)+j(w,b,f,v)+y+t[w]+m[x]>>>0;y=v,v=f,f=O(b,30)>>>0,b=g,g=_}a[0]=a[0]+g>>>0,a[1]=a[1]+b>>>0,a[2]=a[2]+f>>>0,a[3]=a[3]+v>>>0,a[4]=a[4]+y>>>0}return[a[0]>>24&255,a[0]>>16&255,a[0]>>8&255,255&a[0],a[1]>>24&255,a[1]>>16&255,a[1]>>8&255,255&a[1],a[2]>>24&255,a[2]>>16&255,a[2]>>8&255,255&a[2],a[3]>>24&255,a[3]>>16&255,a[3]>>8&255,255&a[3],a[4]>>24&255,a[4]>>16&255,a[4]>>8&255,255&a[4]]})),_=a("iZOS"),T=a("RKiO");function k(e){let t=e;const a=[];for(;t;){const e=t.search(/\|=|\|~|!=|!~/);if(-1===e)break;const r=t.substr(e,2),n=0===t.substr(e).search(/!=|!~/);if(t=t.substr(e+2),n)continue;const i=t.search(/\|=|\|~|!=|!~/);let o;-1===i?o=t.trim():(o=t.substr(0,i).trim(),t=t.substr(i));const l=o.match(/"(.*?)"/),c=o.match(/`(.*?)`/),u=l||c;if(!u)return a;{const e=u[1];"|~"===r?a.push(c?e:e.replace(/\\\\/g,"\\")):a.push(Object(s.escapeRegExp)(e))}}return a}let L;function S(){return(S=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}!function(e){e.Stream="streams",e.Vector="vector",e.Matrix="matrix"}(L||(L={}));function C(e,t,a){const s=e.stream,n=Object.entries(s).map(([e,t])=>`${e}="${t}"`).sort().join(""),i=new r.ArrayVector([]),o=new r.ArrayVector([]),l=new r.ArrayVector([]),c=new r.ArrayVector([]),u={};for(const[t,r]of e.values)i.add(new Date(parseInt(t.substr(0,t.length-6),10)).toISOString()),o.add(t),l.add(r),c.add(F(t,n,r,u,a));return function(e,t,a,s,n,i,o){const l={refId:o,fields:[{name:"ts",type:r.FieldType.time,config:{displayName:"Time"},values:e},{name:"line",type:r.FieldType.string,config:{},values:a,labels:n},{name:"id",type:r.FieldType.string,config:{},values:s},{name:"tsNs",type:r.FieldType.time,config:{displayName:"Time ns"},values:t}],length:e.length};if(i){const e=new r.MutableDataFrame(l);return e.reverse(),e}return l}(i,o,l,c,s,t,a)}function F(e,t,a,r,s){let n=w(`${e}_${t}_${a}`,"6ec946da-0f49-47a8-983a-1d76d17e7c92");if(n in r){const e=r[n]+1;r[n]=e,n=`${n}_${e}`}else r[n]=0;return s?`${n}_${s}`:n}function I(e,t){const a=function(e,t){var a;let r=void 0===t||Object(s.isEmpty)(t.legendFormat)?function(e){const t=e.__name__||"";delete e.__name__;const a=Object.entries(e).map(e=>`${e[0]}="${e[1]}"`).join(",");return`${t}{${a}}`}(e):(n=Object(h.getTemplateSrv)().replace(null!==(a=t.legendFormat)&&void 0!==a?a:"",t.scopedVars),i=e,n.replace(/\{\{\s*(.+?)\s*\}\}/g,(e,t)=>i[t]?i[t]:t));var n,i;!r&&t&&(r=t.query);return r}(e.metric,t);return{target:a,title:a,datapoints:R(e.values,t),tags:e.metric,meta:t.meta,refId:t.refId}}function R(e,t){const a=1e3*t.step,r=[];let s=t.start/1e6;for(const[t,n]of e){let e=parseFloat(n);isNaN(e)&&(e=null);const i=1e3*t;for(let e=s;e<i;e+=a)r.push([null,e]);s=i+a,r.push([e,i])}const n=t.end/1e6;for(let e=s;e<=n;e+=a)r.push([null,e]);return r}function q(e,t,a,s,n){if(!e||0===e.length)return new _.a;const i=[...new Set(e.reduce((e,t)=>e.concat(Object.keys(t.metric)),[])).values()].sort(),o=new _.a;return o.refId=a,o.meta=s,o.columns=[{text:"Time",type:r.FieldType.time},...i.map(e=>({text:e,filterable:!0,type:r.FieldType.string})),{text:t>1||n?"Value #"+a:"Value",type:r.FieldType.number}],e.forEach(e=>{const t={metric:e.metric,values:e.value?[e.value]:e.values};t.values&&(t.metric?o.rows.push(...t.values.map(([e,a])=>[1e3*e,...i.map(e=>t.metric[e]||""),parseFloat(a)])):o.rows.concat(t.values.map(([e,t])=>[1e3*e,parseFloat(t)])))}),o}function E(e,t,a,r,n=!1){const i=a>0?e.data.result:[],o=function(e){const t=[];if(!e)return t;for(const r in e){const n=e[r];for(const e in n){const i=n[e];let o;/time/i.test(e)&&i?o="s":/bytes.*persecond/i.test(e)?o="Bps":/bytes/i.test(e)&&(o="decbytes");const l=`${Object(s.capitalize)(r)}: ${a=e,a.replace(/[A-Z]/g,e=>" "+e.toLowerCase())}`;t.push({displayName:l,value:i,unit:o})}}var a;return t}(e.data.stats),l={searchWords:k((c=t.expr,(""+(c||"")).trim())),limit:a,stats:o,custom:{lokiQueryStatKey:"Summary: total bytes processed"},preferredVisualisationType:"logs"};var c;const u=i.map(e=>{const a=C(e,n,t.refId);return N(a,r),l.custom&&a.fields.some(e=>e.labels&&Object.keys(e.labels).some(e=>"__error__"===e))&&(l.custom.error="Error when parsing some of the logs"),S({},a,{refId:t.refId,meta:l})});return o.length&&!i.length?[{fields:[],length:0,refId:t.refId,meta:l}]:u}const N=(e,t)=>{var a;if(!t)return;const n=null!==(a=t.derivedFields)&&void 0!==a?a:[];if(!n.length)return;const i=Object(s.groupBy)(n,"name"),o=Object.values(i).map(Q);new r.DataFrameView(e).forEach(e=>{for(const t of o){const a=e.line.match(i[t.name][0].matcherRegex);t.values.add(a&&a[1])}}),e.fields=[...e.fields,...o]};function Q(e){const t=Object(h.getDataSourceSrv)(),a=e.reduce((e,a)=>{if(a.datasourceUid){var r;const s=t.getInstanceSettings(a.datasourceUid);e.push({title:"",url:"",internal:{query:{query:a.url},datasourceUid:a.datasourceUid,datasourceName:null!==(r=null==s?void 0:s.name)&&void 0!==r?r:"Data source not found"}})}else a.url&&e.push({title:"",url:a.url});return e},[]);return{name:e[0].name,type:r.FieldType.string,config:{links:a},values:new r.ArrayVector([])}}function $(e,t,a,r,s){var n;const i={format:a.format,legendFormat:null!==(n=a.legendFormat)&&void 0!==n?n:"",start:t.start,end:t.end,step:t.step,query:t.query,responseListLength:r,refId:a.refId,meta:{preferredVisualisationType:"graph"},valueWithRefId:a.valueWithRefId,scopedVars:s};switch(e.data.resultType){case L.Vector:return e.data.result.map(e=>I({metric:e.metric,values:[e.value]},i));case L.Matrix:return e.data.result.map(e=>I(e,i));default:return[]}}var D=a("gI3B"),A=a("4HpG"),P=a("K9Ia"),V=a("FFOo"),U=a("6blF"),M=a("pugT"),W=a("S5bw"),B={url:"",deserializer:function(e){return JSON.parse(e.data)},serializer:function(e){return JSON.stringify(e)}},K=function(e){function t(t,a){var r=e.call(this)||this;if(t instanceof U.a)r.destination=a,r.source=t;else{var s=r._config=A.a({},B);if(r._output=new P.b,"string"==typeof t)s.url=t;else for(var n in t)t.hasOwnProperty(n)&&(s[n]=t[n]);if(!s.WebSocketCtor&&WebSocket)s.WebSocketCtor=WebSocket;else if(!s.WebSocketCtor)throw new Error("no WebSocket constructor can be found");r.destination=new W.a}return r}return A.b(t,e),t.prototype.lift=function(e){var a=new t(this._config,this.destination);return a.operator=e,a.source=this,a},t.prototype._resetState=function(){this._socket=null,this.source||(this.destination=new W.a),this._output=new P.b},t.prototype.multiplex=function(e,t,a){var r=this;return new U.a((function(s){try{r.next(e())}catch(e){s.error(e)}var n=r.subscribe((function(e){try{a(e)&&s.next(e)}catch(e){s.error(e)}}),(function(e){return s.error(e)}),(function(){return s.complete()}));return function(){try{r.next(t())}catch(e){s.error(e)}n.unsubscribe()}}))},t.prototype._connectSocket=function(){var e=this,t=this._config,a=t.WebSocketCtor,r=t.protocol,s=t.url,n=t.binaryType,i=this._output,o=null;try{o=r?new a(s,r):new a(s),this._socket=o,n&&(this._socket.binaryType=n)}catch(e){return void i.error(e)}var l=new M.a((function(){e._socket=null,o&&1===o.readyState&&o.close()}));o.onopen=function(t){if(!e._socket)return o.close(),void e._resetState();var a=e._config.openObserver;a&&a.next(t);var r=e.destination;e.destination=V.a.create((function(t){if(1===o.readyState)try{var a=e._config.serializer;o.send(a(t))}catch(t){e.destination.error(t)}}),(function(t){var a=e._config.closingObserver;a&&a.next(void 0),t&&t.code?o.close(t.code,t.reason):i.error(new TypeError("WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }")),e._resetState()}),(function(){var t=e._config.closingObserver;t&&t.next(void 0),o.close(),e._resetState()})),r&&r instanceof W.a&&l.add(r.subscribe(e.destination))},o.onerror=function(t){e._resetState(),i.error(t)},o.onclose=function(t){e._resetState();var a=e._config.closeObserver;a&&a.next(t),t.wasClean?i.complete():i.error(t)},o.onmessage=function(t){try{var a=e._config.deserializer;i.next(a(t))}catch(e){i.error(e)}}},t.prototype._subscribe=function(e){var t=this,a=this.source;return a?a.subscribe(e):(this._socket||this._connectSocket(),this._output.subscribe(e),e.add((function(){var e=t._socket;0===t._output.observers.length&&(e&&1===e.readyState&&e.close(),t._resetState())})),e)},t.prototype.unsubscribe=function(){var t=this._socket;t&&1===t.readyState&&t.close(),this._resetState(),e.prototype.unsubscribe.call(this)},t}(P.a);var z=a("ZqrO"),H=a("psW0"),J=a("2WpN");function Z(){return(Z=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}class X{constructor(){var e,t,a;a={},(t="streams")in(e=this)?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a}getStream(e,t=5e3){let a=this.streams[e.url];if(a)return a;const s=new r.CircularDataFrame({capacity:e.size});var i;return s.addField({name:"ts",type:r.FieldType.time,config:{displayName:"Time"}}),s.addField({name:"tsNs",type:r.FieldType.time,config:{displayName:"Time ns"}}),s.addField({name:"line",type:r.FieldType.string}).labels=Object(r.parseLabels)(e.query),s.addField({name:"labels",type:r.FieldType.other}),s.addField({name:"id",type:r.FieldType.string}),s.meta=Z({},s.meta,{preferredVisualisationType:"logs"}),s.refId=e.refId,a=(i=e.url,new K(i)).pipe(Object(l.a)(e=>(function(e,t){const a=e.streams;if(!a||!a.length)return;let s={};for(const e of t.fields)if(e.type===r.FieldType.string){e.labels&&(s=e.labels);break}const n=t.fields[0],i=t.fields[1],o=t.fields[2],l=t.fields[3],c=t.fields[4],u={};for(const e of a){const a=Object(r.findUniqueLabels)(e.stream,s),d=Object.entries(e.stream).map(([e,t])=>`${e}="${t}"`).sort().join("");for(const[r,s]of e.values)n.values.add(new Date(parseInt(r.substr(0,r.length-6),10)).toISOString()),i.values.add(r),o.values.add(s),l.values.add(a),c.values.add(F(r,d,s,u,t.refId))}}(e,s),[s])),Object(z.a)(e=>e.pipe(Object(H.b)((e,a)=>{const r=a+1;return 1006===e.code&&r<30?(r>10&&console.warn("Websocket connection is being disrupted. We keep reconnecting but consider starting new live tailing again. Error: "+e.reason),Object(D.a)(t)):Object(n.a)(e)}))),Object(J.a)(()=>{delete this.streams[e.url]})),this.streams[e.url]=a,a}}var Y=a("HyWp"),G=a.n(Y),ee=a("ceQ3"),te=a("Mug+");function ae(){return(ae=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const re={"=":"=","!=":"!=","=~":"=~","!=~":"!~"};function se(e,t){let a=!1,r={};if(e.seriesByTagUsed)a=!0,e.tags.forEach(e=>{r[e.key]={value:e.value,operator:re[e.operator]}});else{const s=e.segments.map(e=>e.value);let n=t.mappings.filter(e=>e.matchers.length<=s.length);for(let e of n){a=e.matchers.concat().every((e,t)=>{if(e.labelName){let n=s[t];if("*"===n)return!0;const i=(a=n).includes("*")||a.includes("{")?"^"+a.replace(/\*/g,".*").replace(/\{/g,"(").replace(/}/g,")").replace(/,/g,"|"):a;return r[e.labelName]={value:i,operator:i!==n?"=~":"="},!0}var a;return s[t]===e.value||"*"===e.value})}}let n=Object(s.map)(r,(e,t)=>`${t}${e.operator}"${e.value}"`);return a&&n.length?`{${n.join(", ")}}`:""}function ne(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function ie(){return(ie=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const oe=["job","namespace"],le=[{label:"$__interval",sortValue:"$__interval"},{label:"$__range",sortValue:"$__range"},{label:"1m",sortValue:"00:01:00"},{label:"5m",sortValue:"00:05:00"},{label:"10m",sortValue:"00:10:00"},{label:"30m",sortValue:"00:30:00"},{label:"1h",sortValue:"01:00:00"},{label:"1d",sortValue:"24:00:00"}],ce=e=>({label:e,filterText:`"${e}"`});class ue extends r.LanguageProvider{constructor(e,t){super(),ne(this,"labelKeys",void 0),ne(this,"labelFetchTs",void 0),ne(this,"started",!1),ne(this,"datasource",void 0),ne(this,"lookupsDisabled",!1),ne(this,"seriesCache",new G.a(10)),ne(this,"labelsCache",new G.a(10)),ne(this,"cleanText",e=>e.replace(/[{}[\]="(),!~+\-*/^%\|]/g,"").trim()),ne(this,"request",async(e,t)=>{try{return await this.datasource.metadataRequest(e,t)}catch(e){console.error(e)}}),ne(this,"start",()=>(this.startTask||(this.startTask=this.fetchLabels().then(()=>(this.started=!0,[]))),this.startTask)),ne(this,"getBeginningCompletionItems",e=>({suggestions:[...this.getEmptyCompletionItems(e).suggestions,...this.getTermCompletionItems().suggestions]})),ne(this,"getTermCompletionItems",()=>{const e=[];return e.push({prefixMatch:!0,label:"Functions",items:T.a.map(e=>ie({},e,{kind:"function"}))}),{suggestions:e}}),ne(this,"getPipeCompletionItem",()=>{const e=[];return e.push({label:"Operators",items:T.b.map(e=>ie({},e,{kind:"operators"}))}),e.push({label:"Parsers",items:T.c.map(e=>ie({},e,{kind:"parsers"}))}),{suggestions:e}}),ne(this,"fetchSeriesLabels",async e=>{const t="/loki/api/v1/series",{start:a,end:r}=this.datasource.getTimeRangeParams(),s=this.generateCacheKey(t,a,r,e);let n=this.seriesCache.get(s);if(!n){this.seriesCache.set(s,{});const i={"match[]":e,start:a,end:r},o=await this.request(t,i),{values:l}=Object(ee.h)(o);n=l,this.seriesCache.set(s,n)}return n}),ne(this,"fetchSeries",async e=>{const{start:t,end:a}=this.datasource.getTimeRangeParams(),r={"match[]":e,start:t,end:a};return await this.request("/loki/api/v1/series",r)}),this.datasource=e,this.labelKeys=[],this.labelFetchTs=0,Object.assign(this,t)}getSyntax(){return T.d}getLabelKeys(){return this.labelKeys}async provideCompletionItems(e,t){const{wrapperClasses:a,value:r,prefix:s,text:n}=e,i={suggestions:[]};if(!r)return i;const o=0===(null==r?void 0:r.document.text.length),l=r.document.getTextsAtRange(r.selection),c=1===l.size?l.first().getText():null,u=c?c[r.selection.anchor.offset]:null,d=a.length>3,m=s&&!d,h=!u||")"===u,p=s&&!n.match(/^['"~=\]})\s]+$/)&&h,g=n.match(/[+\-*/^%]/);return a.includes("context-range")?this.getRangeCompletionItems():a.includes("context-labels")?await this.getLabelCompletionItems(e):a.includes("context-pipe")?this.getPipeCompletionItem():o?this.getEmptyCompletionItems(t):m&&h&&!g?this.getBeginningCompletionItems(t):m&&p?this.getTermCompletionItems():i}getEmptyCompletionItems(e){const t=null==e?void 0:e.history,a=[];if(null!=t&&t.length){const e=Object(s.chain)(t).map(e=>e.query.expr).filter().uniq().take(10).map(ce).map(e=>function(e,t){const a=Date.now()-864e5,s=t.filter(t=>t.ts>a&&t.query.expr===e.label);let n=`Queried ${s.length} times in the last 24h.`;const i=s[0];if(i){n=`${n} Last queried ${Object(r.dateTime)(i.ts).fromNow()}.`}return ie({},e,{documentation:n})}(e,t)).value();a.push({prefixMatch:!0,skipSort:!0,label:"History",items:e})}return{suggestions:a}}getRangeCompletionItems(){return{context:"context-range",suggestions:[{label:"Range vector",items:[...le]}]}}async getLabelCompletionItems({text:e,wrapperClasses:t,labelKey:a,value:r}){let n="context-labels";const i=[];if(!r)return{context:n,suggestions:[]};const o=r.anchorBlock.getText(),l=r.selection.anchor.offset,c=e.match(/^(=|=~|!=|!~)/);let u,d;try{d=Object(ee.f)(o,l),u=d.selector}catch{u="{}"}if(!a&&"{}"===u){await this.start();return{context:n,suggestions:[{label:"Labels",items:this.getLabelKeys().map(ce)}]}}const m=d?d.labelKeys:[];let h;if(u)if("{}"===u&&a){h={[a]:await this.getLabelValues(a)}}else h=await this.getSeriesLabels(u);if(!h)return console.warn("Server did not return any values for selector = "+u),{context:n,suggestions:i};if(e&&c||t.includes("attr-value"))a&&h[a]&&(n="context-label-values",i.push({label:`Label values for "${a}"`,items:h[a].map(ce).filter(({filterText:t})=>t!==e)}));else{const e=h?Object.keys(h):oe;if(e){const t=Object(s.difference)(e,m);if(t.length){const e={label:"Labels",items:t.map(e=>({label:e}))};i.push(e)}}}return{context:n,suggestions:i}}async importQueries(e,t){const a=t.meta.id;return"prometheus"===a?Promise.all(e.map(async e=>{const t=await this.importPrometheusQuery(e.expr),a=ie({},e);return ie({},a,{expr:t})})):"graphite"===a?(r=t,e.map(e=>{const t=new te.a(r,ae({},e,{target:e.target||"",textEditor:!1}),Object(p.a)());return t.parseTarget(),{refId:e.refId,expr:se(t,r.getImportQueryConfiguration().loki)}})):e.map(e=>({refId:e.refId,expr:""}));var r}async importPrometheusQuery(e){if(!e)return"";const t=e.match(ee.k);if(!t)return"";const a=t[0],r={};a.replace(ee.d,(e,t,a,s)=>(r[t]={value:s,operator:a},"")),await this.start();const s=this.labelKeys;let n={};if(s&&s.length)for(const e in r)s&&s.includes(e)&&(n[e]=r[e]);else n=r;return["{",Object.keys(n).sort().map(e=>`${e}${n[e].operator}${n[e].value}`).join(","),"}"].join("")}async getSeriesLabels(e){if(!this.lookupsDisabled)try{return await this.fetchSeriesLabels(e)}catch(e){return void console.error(e)}}async fetchLabels(){const e=this.datasource.getTimeRangeParams();this.labelFetchTs=Date.now().valueOf();const t=await this.request("/loki/api/v1/label",e);return Array.isArray(t)&&(this.labelKeys=t.slice().sort()),[]}async refreshLogLabels(e){(this.labelKeys&&Date.now().valueOf()-this.labelFetchTs>3e4||e)&&await this.fetchLabels()}generateCacheKey(e,t,a,r){return[e,this.roundTime(t),this.roundTime(a),r].join()}roundTime(e){return e?Math.floor(e/1e6/1e3/60/5):0}async getLabelValues(e){return await this.fetchLabelValues(e)}async fetchLabelValues(e){var t;const a=`/loki/api/v1/label/${e}/values`,r=this.datasource.getTimeRangeParams(),{start:s,end:n}=r,i=this.generateCacheKey(a,s,n,e),o={start:s,end:n};let l=this.labelsCache.get(i);if(!l){this.labelsCache.set(i,[]);const e=await this.request(a,o);Array.isArray(e)&&(l=e.slice().sort(),this.labelsCache.set(i,l))}return null!==(t=l)&&void 0!==t?t:[]}}var de=a("zsCE");function me(){return(me=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function he(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}const pe={direction:"BACKWARD",limit:1e3,query:""};class ge extends r.DataSourceApi{constructor(e,t=Object(p.a)(),a=Object(b.a)()){var s;super(e),he(this,"streams",new X),he(this,"languageProvider",void 0),he(this,"maxLines",void 0),he(this,"runInstantQuery",(e,t,a=1)=>{const r=this.getTime(t.range.to,!0),s=ye(e.expr)?t.maxDataPoints:e.maxLines,n={query:e.expr,time:""+(r+(1e9-r%1e9)),limit:Math.min(s||1/0,this.maxLines)},i={preferredVisualisationType:"table"};return this._request("/loki/api/v1/query",n).pipe(Object(l.a)(t=>t.data.data.resultType===L.Stream?{data:t.data?E(t.data,e,n.limit,this.instanceSettings.jsonData):[],key:e.refId+"_instant"}:{data:[q(t.data.data.result,a,e.refId,i,!0)],key:e.refId+"_instant"}),Object(c.a)(t=>this.throwUnless(t,404===t.status,e)))}),he(this,"runRangeQuery",(e,t,a=1)=>{let r=ye(e.expr)?t.maxDataPoints||this.maxLines:e.maxLines||this.maxLines;if(t.liveStreaming)return this.runLiveQuery(e,r);const s=this.createRangeQuery(e,t,r);return this._request("/loki/api/v1/query_range",s).pipe(Object(c.a)(t=>this.throwUnless(t,404===t.status,e)),Object(u.a)(n=>function(e,t,a,r,s,n,o,l=!1){switch(e.data.resultType){case L.Stream:return Object(i.a)({data:E(e,t,s,n,l),key:t.refId+"_log"});case L.Vector:case L.Matrix:return Object(i.a)({data:$(e,a,S({},t,{format:"time_series"}),r,o),key:t.refId});default:throw new Error(`Unknown result type "${e.data.resultType}".`)}}(n.data,e,s,a,r,this.instanceSettings.jsonData,t.scopedVars,t.reverse)))}),he(this,"runLiveQuery",(e,t)=>{const a=this.createLiveTarget(e,t);return this.streams.getStream(a).pipe(Object(l.a)(e=>({data:e||[],key:"loki-"+a.refId,state:r.LoadingState.Streaming})),Object(c.a)(e=>Object(n.a)("Live tailing was stopped due to following error: "+e.reason)))}),he(this,"getLogRowContext",(e,t)=>{const a=this.prepareLogRowContextQueryTarget(e,t&&t.limit||10,t&&t.direction||"BACKWARD"),r=t&&"FORWARD"===t.direction;return this._request("/loki/api/v1/query_range",a).pipe(Object(c.a)(e=>{if(404===e.status)return Object(i.a)(e);throw{message:"Error during context query. Please check JS console logs.",status:e.status,statusText:e.statusText}}),Object(u.a)(e=>Object(i.a)({data:e.data?e.data.data.result.map(e=>C(e,r)):[]}))).toPromise()}),he(this,"prepareLogRowContextQueryTarget",(e,t,a)=>{const s=Object.keys(e.labels).map(t=>`${t}="${e.labels[t].replace(/\\/g,"\\\\")}"`).join(","),n={limit:t,query:`{${s}}`,expr:`{${s}}`,direction:a},i=new r.FieldCache(e.dataFrame).getFieldByName("tsNs").values.get(e.rowIndex);return me({},n,"BACKWARD"===a?{start:e.timeEpochMs-72e5+"000000",end:i,direction:a}:{start:i,end:e.timeEpochMs+72e5+"000000"})}),this.instanceSettings=e,this.templateSrv=t,this.timeSrv=a,this.languageProvider=new ue(this);const o=e.jsonData||{};this.maxLines=parseInt(null!==(s=o.maxLines)&&void 0!==s?s:"0",10)||1e3}_request(e,t,a){const r=this.instanceSettings.url,s=t?Object(de.d)(t):"",n=`${r}${e}${s.length?"?"+s:""}`;(this.instanceSettings.withCredentials||this.instanceSettings.basicAuth)&&(a=me({},a,{withCredentials:!0}),this.instanceSettings.basicAuth&&(a.headers=me({},a.headers,{Authorization:this.instanceSettings.basicAuth})));const i=me({},a,{url:n});return Object(h.getBackendSrv)().fetch(i)}query(e){const t=[],a=me({},e.scopedVars,this.getRangeScopedVars(e.range)),n=e.targets.filter(e=>e.expr&&!e.hide).map(e=>{const t=this.addAdHocFilters(e.expr);return me({},e,{expr:this.templateSrv.replace(t,a,this.interpolateQueryExpr)})});for(const a of n)a.instant?t.push(this.runInstantQuery(a,e,n.length)):t.push(this.runRangeQuery(a,e,n.length));return Object(s.isEmpty)(t)?Object(i.a)({data:[],state:r.LoadingState.Done}):Object(o.a)(...t)}createRangeQuery(e,t,a){const r=e.expr;let s={};if(t.range){const e=this.getTime(t.range.from,!1),a=this.getTime(t.range.to,!0),r=Math.ceil((a-e)/1e6),n=this.adjustInterval(t.intervalMs||1e3,r)/1e3;s={start:e,end:a,step:Math.ceil(1e3*n)/1e3}}return me({},pe,s,{query:r,limit:a})}createLiveTarget(e,t){const a=e.expr,r=this.instanceSettings.url,s=Object(de.d)({query:a});return{query:a,url:Object(f.d)(`${r}/loki/api/v1/tail?${s}`),refId:e.refId,size:t}}getRangeScopedVars(e=this.timeSrv.timeRange()){const t=e.to.diff(e.from),a=Math.round(t/1e3);return{__range_ms:{text:t,value:t},__range_s:{text:a,value:a},__range:{text:a+"s",value:a+"s"}}}interpolateVariablesInQueries(e,t){let a=e;return e&&e.length&&(a=e.map(e=>me({},e,{datasource:this.name,expr:this.templateSrv.replace(e.expr,t,this.interpolateQueryExpr)}))),a}getQueryDisplayText(e){return e.expr}getTimeRangeParams(){const e=this.timeSrv.timeRange();return{start:1e6*e.from.valueOf(),end:1e6*e.to.valueOf()}}async importQueries(e,t){return this.languageProvider.importQueries(e,t)}async metadataRequest(e,t){const a=await this._request(e,t,{hideFromInspector:!0}).toPromise();return a.data.data||a.data.values||[]}async metricFindQuery(e){if(!e)return Promise.resolve([]);const t=this.templateSrv.replace(e,{},this.interpolateQueryExpr);return await this.processMetricFindQuery(t)}async processMetricFindQuery(e){if(e.match(/^label_names\(\)\s*$/))return await this.labelNamesQuery();const t=e.match(/^label_values\((?:(.+),\s*)?([a-zA-Z_][a-zA-Z0-9_]*)\)\s*$/);return t?t[1]?await this.labelValuesSeriesQuery(t[1],t[2]):await this.labelValuesQuery(t[2]):Promise.resolve([])}async labelNamesQuery(){const e=this.getTimeRangeParams();return(await this.metadataRequest("/loki/api/v1/label",e)).map(e=>({text:e}))}async labelValuesQuery(e){const t=this.getTimeRangeParams(),a=`/loki/api/v1/label/${e}/values`;return(await this.metadataRequest(a,t)).map(e=>({text:e}))}async labelValuesSeriesQuery(e,t){const a=me({},this.getTimeRangeParams(),{"match[]":e}),r=new Set;return(await this.metadataRequest("/loki/api/v1/series",a)).forEach(e=>{e[t]&&r.add({text:e[t]})}),Array.from(r)}async getTagKeys(){return await this.labelNamesQuery()}async getTagValues(e={}){return await this.labelValuesQuery(e.key)}interpolateQueryExpr(e,t){if(!t.multi&&!t.includeAll)return fe(e);if("string"==typeof e)return ve(e);return Object(s.map)(e,ve).join("|")}modifyQuery(e,t){var a;let r=null!==(a=e.expr)&&void 0!==a?a:"";switch(t.type){case"ADD_FILTER":r=this.addLabelToQuery(r,t.key,t.value,"=");break;case"ADD_FILTER_OUT":r=this.addLabelToQuery(r,t.key,t.value,"!=")}return me({},e,{expr:r})}getHighlighterExpression(e){return k(e.expr)}getTime(e,t){return"string"==typeof e&&(e=r.dateMath.parse(e,t)),Math.ceil(1e6*e.valueOf())}testDatasource(){const e=Date.now()-6e5+"000000";return this._request("/loki/api/v1/label",{start:e}).pipe(Object(l.a)(e=>{var t,a;return((null==e||null===(t=e.data)||void 0===t?void 0:t.data)||(null==e||null===(a=e.data)||void 0===a?void 0:a.values)||[]).length>0?{status:"success",message:"Data source connected and labels found."}:{status:"error",message:"Data source connected, but no labels received. Verify that Loki and Promtail is configured properly."}}),Object(c.a)(e=>{let t="Loki: ";return e.statusText?t+=e.statusText:t+="Cannot connect to Loki",e.status&&(t+=". "+e.status),e.data&&e.data.message?t+=". "+e.data.message:e.data&&(t+=". "+e.data),Object(i.a)({status:"error",message:t})})).toPromise()}async annotationQuery(e){const{expr:t,maxLines:a,instant:s,tagKeys:n="",titleFormat:i="",textFormat:o=""}=e.annotation;if(!t)return[];const l=this.templateSrv.replace(t,{},this.interpolateQueryExpr),c={refId:"annotation-"+e.annotation.name,expr:l,maxLines:a,instant:s},{data:u}=s?await this.runInstantQuery(c,e).toPromise():await this.runRangeQuery(c,e).toPromise(),d=[],m=n.split(",").filter(e=>""!==e);for(const e of u){const t={};for(const a of e.fields)if(a.labels)for(const[e,r]of Object.entries(a.labels))t[e]=String(r).trim();const a=[...new Set(Object.entries(t).reduce((e,[t,a])=>(""===a||m.length&&!m.includes(t)||e.push.apply(e,[a]),e),[]))];new r.DataFrameView(e).forEach(e=>{d.push({time:new Date(e.ts).valueOf(),title:be(i,t),text:be(o,t)||e.line,tags:a})})}return d}showContextToggle(e){return!0===(e&&e.searchWords&&e.searchWords.length>0)}throwUnless(e,t,a){if(t)return Object(i.a)(e);throw this.processError(e,a)}processError(e,t){let a=Object(s.cloneDeep)(e);return e.data.message.includes("escape")&&t.expr.includes("\\")&&(a.data.message=`Error: ${e.data.message}. Make sure that all special characters are escaped with \\. For more information on escaping of special characters visit LogQL documentation at https://grafana.com/docs/loki/latest/logql/.`),a}adjustInterval(e,t){return 0!==e&&t/e>11e3&&(e=Math.ceil(t/11e3)),Math.max(e,1)}addAdHocFilters(e){let t=e;return t=this.templateSrv.getAdhocFilters(this.name).reduce((e,t)=>{const{key:a,operator:r}=t;let{value:s}=t;return"=~"!==r&&"!~"!==r||(s=fe(s)),this.addLabelToQuery(e,a,s,r)},t),t}addLabelToQuery(e,t,a,r){return function(e){const t=T.c.map(e=>""+e.label).join("|");return new RegExp(`\\|\\s?(${t})`).test(e)}(e)&&!ye(e)?function(e,t,a,r){return e+` | ${t}${r}"${a.toString()}"`}(e,t,a,r):Object(g.a)(e,t,a,r,!0)}}function be(e,t){return e.replace(/\{\{\s*(.+?)\s*\}\}/g,(e,a)=>t[a]?t[a]:"")}function fe(e){return"string"==typeof e?e.replace(/'/g,"\\\\'"):e}function ve(e){return"string"==typeof e?fe(e.replace(/\\/g,"\\\\\\\\").replace(/[$^*{}\[\]+?.()|]/g,"\\\\$&")):e}function ye(e){return m.a.tokenize(e,T.d).some(e=>"string"!=typeof e&&"function"===e.type)}var xe,je,Oe,we,_e,Te,ke,Le,Se,Ce=ge,Fe=a("q1tI"),Ie=a("nKUr");function Re(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}const qe=['{job="default/prometheus"}'],Ee=["job","app","k8s_app"],Ne=[{title:"Log pipeline",expression:'{job="mysql"} |= "metrics" | logfmt | duration > 10s',label:'This query targets the MySQL job, filters out logs that don’t contain the word "metrics" and parses each log line to extract more labels and filters with them.'},{title:"Count over time",expression:'count_over_time({job="mysql"}[5m])',label:"This query counts all the log lines within the last five minutes for the MySQL job."},{title:"Rate",expression:'rate(({job="mysql"} |= "error" != "timeout")[10s])',label:"This query gets the per-second rate of all non-timeout errors within the last ten seconds for the MySQL job."},{title:"Aggregate, count, and group",expression:'sum(count_over_time({job="mysql"}[5m])) by (level)',label:"Get the count of logs during the last five minutes, grouping by level."}];class Qe extends Fe.PureComponent{constructor(...e){super(...e),Re(this,"state",{userExamples:qe}),Re(this,"checkUserLabels",async()=>{var e;const t=null===(e=this.props.datasource)||void 0===e?void 0:e.languageProvider;if(t.started){const e=t.getLabelKeys()||[],a=Ee.find(t=>e.includes(t));if(a){const e=await t.getLabelValues(a),r=Object(s.shuffle)(e).slice(0,5).map(e=>`{${a}="${e}"}`);this.setState({userExamples:r})}}else this.scheduleUserLabelChecking()})}componentDidMount(){this.scheduleUserLabelChecking()}componentWillUnmount(){clearTimeout(this.userLabelTimer)}scheduleUserLabelChecking(){this.userLabelTimer=setTimeout(this.checkUserLabels,1e3)}renderExpression(e){const{onClickExample:t}=this.props;return Object(Ie.jsx)("div",{className:"cheat-sheet-item__example",onClick:a=>t({refId:"A",expr:e}),children:Object(Ie.jsx)("code",{children:e})},e)}render(){const{userExamples:e}=this.state;return Object(Ie.jsxs)("div",{children:[xe||(xe=Object(Ie.jsx)("h2",{children:"Loki Cheat Sheet"})),Object(Ie.jsxs)("div",{className:"cheat-sheet-item",children:[je||(je=Object(Ie.jsx)("div",{className:"cheat-sheet-item__title",children:"See your logs"})),Oe||(Oe=Object(Ie.jsx)("div",{className:"cheat-sheet-item__label",children:"Start by selecting a log stream from the Log labels selector."})),we||(we=Object(Ie.jsx)("div",{className:"cheat-sheet-item__label",children:"Alternatively, you can write a stream selector into the query field:"})),this.renderExpression('{job="default/prometheus"}'),e!==qe&&e.length>0?Object(Ie.jsxs)("div",{children:[_e||(_e=Object(Ie.jsx)("div",{className:"cheat-sheet-item__label",children:"Here are some example streams from your logs:"})),e.map(e=>this.renderExpression(e))]}):null]}),Object(Ie.jsxs)("div",{className:"cheat-sheet-item",children:[Te||(Te=Object(Ie.jsx)("div",{className:"cheat-sheet-item__title",children:"Combine stream selectors"})),this.renderExpression('{app="cassandra",namespace="prod"}'),ke||(ke=Object(Ie.jsx)("div",{className:"cheat-sheet-item__label",children:"Returns all log lines from streams that have both labels."}))]}),Object(Ie.jsxs)("div",{className:"cheat-sheet-item",children:[Le||(Le=Object(Ie.jsx)("div",{className:"cheat-sheet-item__title",children:"Filtering for search terms."})),this.renderExpression('{app="cassandra"} |~ "(duration|latency)s*(=|is|of)s*[d.]+"'),this.renderExpression('{app="cassandra"} |= "exact match"'),this.renderExpression('{app="cassandra"} != "do not match"'),Se||(Se=Object(Ie.jsxs)("div",{className:"cheat-sheet-item__label",children:[Object(Ie.jsx)("a",{href:"https://grafana.com/docs/loki/latest/logql/#log-pipeline",target:"logql",children:"LogQL"})," ","supports exact and regular expression filters."]}))]}),Ne.map(e=>Object(Ie.jsxs)("div",{className:"cheat-sheet-item",children:[Object(Ie.jsx)("div",{className:"cheat-sheet-item__title",children:e.title}),this.renderExpression(e.expression),Object(Ie.jsx)("div",{className:"cheat-sheet-item__label",children:e.label})]},e.expression))]})}}var $e=a("csYu"),De=a("SuF/");function Ae(e){var t;const{query:a,data:r,datasource:s,history:n,onChange:i,onRunQuery:o,range:l}=e;return Object(Ie.jsx)($e.a,{datasource:s,query:a,onChange:i,onBlur:()=>{},onRunQuery:o,history:n,data:r,range:l,ExtraFieldElement:Object(Ie.jsx)(De.a,{queryType:a.instant?"instant":"range",lineLimitValue:(null==a||null===(t=a.maxLines)||void 0===t?void 0:t.toString())||"",query:a,onRunQuery:o,onChange:i})})}var Pe,Ve=Object(Fe.memo)(Ae),Ue=a("kDLi");function Me(){return(Me=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function We(e){var t;const{query:a,data:r,datasource:s,onChange:n,onRunQuery:i,range:o}=e,l=Object(Ie.jsx)("div",{className:"gf-form-inline",children:Object(Ie.jsxs)("div",{className:"gf-form",children:[Pe||(Pe=Object(Ie.jsx)(Ue.InlineFormLabel,{width:6,tooltip:"Controls the name of the time series, using name or pattern. For example {{hostname}} will be replaced with label value for the label hostname. The legend only applies to metric queries.",children:"Legend"})),Object(Ie.jsx)("input",{type:"text",className:"gf-form-input",placeholder:"legend format",value:a.legendFormat||"",onChange:e=>{const t=Me({},a,{legendFormat:e.currentTarget.value});n(t)},onBlur:i})]})});return Object(Ie.jsx)($e.a,{datasource:s,query:a,onChange:n,onRunQuery:i,onBlur:i,history:[],data:r,"data-testid":Be.editor,range:o,ExtraFieldElement:Object(Ie.jsxs)(Ie.Fragment,{children:[Object(Ie.jsx)(De.a,{queryType:a.instant?"instant":"range",lineLimitValue:(null==a||null===(t=a.maxLines)||void 0===t?void 0:t.toString())||"",query:a,onRunQuery:i,onChange:n,runOnBlur:!0}),l]})})}const Be={editor:"loki-editor"};function Ke(e){const{query:t,data:a,datasource:r,onChange:s,onRunQuery:n}=e;return Object(Ie.jsx)($e.a,{datasource:r,query:t,onChange:s,onRunQuery:n,onBlur:n,history:[],data:a,placeholder:"Enter a Loki query","data-testid":ze.editor})}const ze={editor:"loki-editor-cloud-alerting"};function He(){return(He=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function Je(e){const{app:t}=e;switch(t){case r.CoreApp.CloudAlerting:return Object(Ie.jsx)(Ke,He({},e));default:return Object(Ie.jsx)(We,He({},e))}}var Ze,Xe,Ye,Ge=Object(Fe.memo)(Je);class et{constructor(e){this.annotation=e.ctrl.annotation,this.annotation.target=this.annotation.target||{},this.onQueryChange=this.onQueryChange.bind(this)}onQueryChange(e){this.annotation.expr=e.expr,this.annotation.maxLines=e.maxLines,this.annotation.instant=e.instant}}et.$inject=["$scope"],Ye="partials/annotations.editor.html",(Xe="templateUrl")in(Ze=et)?Object.defineProperty(Ze,Xe,{value:Ye,enumerable:!0,configurable:!0,writable:!0}):Ze[Xe]=Ye;const{FormField:tt}=Ue.LegacyForms,at=e=>{const{value:t,onChange:a}=e;return Object(Ie.jsx)(tt,{label:"Maximum lines",labelWidth:11,inputWidth:20,inputEl:Object(Ie.jsx)("input",{type:"number",className:"gf-form-input width-8 gf-form-input--has-help-icon",value:t,onChange:e=>a(e.currentTarget.value),spellCheck:!1,placeholder:"1000"}),tooltip:Object(Ie.jsx)(Ie.Fragment,{children:"Loki queries must contain a limit of the maximum number of lines returned (default: 1000). Increase this limit to have a bigger result set for ad-hoc analysis. Decrease this limit if your browser becomes sluggish when displaying the log results."})})};var rt=a("vF1F"),st=a("tLXD");function nt(){return(nt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const{Switch:it,FormField:ot}=Ue.LegacyForms,lt=Object(Ue.stylesFactory)(()=>({row:rt.css`
    display: flex;
    align-items: baseline;
  `,nameField:rt.css`
    flex: 2;
  `,regexField:rt.css`
    flex: 3;
  `})),ct=e=>{const{value:t,onChange:a,onDelete:r,suggestions:s,className:n}=e,i=lt(),[o,l]=Object(Fe.useState)(!!t.datasourceUid),c=Object(st.a)(t.datasourceUid);Object(Fe.useEffect)(()=>{c||!t.datasourceUid||o||l(!0),c&&!t.datasourceUid&&o&&l(!1)},[c,t.datasourceUid,o]);const u=e=>r=>{a(nt({},t,{[e]:r.currentTarget.value}))};return Object(Ie.jsxs)("div",{className:n,children:[Object(Ie.jsxs)("div",{className:i.row,children:[Object(Ie.jsx)(ot,{className:i.nameField,labelWidth:5,inputWidth:null,label:"Name",type:"text",value:t.name,onChange:u("name")}),Object(Ie.jsx)(ot,{className:i.regexField,inputWidth:null,label:"Regex",type:"text",value:t.matcherRegex,onChange:u("matcherRegex"),tooltip:"Use to parse and capture some part of the log message. You can use the captured groups in the template."}),Object(Ie.jsx)(Ue.Button,{variant:"destructive",title:"Remove field",icon:"times",onClick:e=>{e.preventDefault(),r()},className:rt.css`
            margin-left: 8px;
          `})]}),Object(Ie.jsx)(ot,{label:o?"Query":"URL",labelWidth:5,inputEl:Object(Ie.jsx)(Ue.DataLinkInput,{placeholder:o?"${__value.raw}":"http://example.com/${__value.raw}",value:t.url||"",onChange:e=>a(nt({},t,{url:e})),suggestions:s}),className:rt.css`
          width: 100%;
        `}),Object(Ie.jsxs)("div",{className:i.row,children:[Object(Ie.jsx)(it,{label:"Internal link",checked:o,onChange:()=>{o&&a(nt({},t,{datasourceUid:void 0})),l(!o)}}),o&&Object(Ie.jsx)(h.DataSourcePicker,{tracing:!0,onChange:e=>a(nt({},t,{datasourceUid:e.uid})),current:t.datasourceUid})]})]})};var ut,dt=a("TSYQ"),mt=a.n(dt),ht=a("Xc1M");const{FormField:pt}=Ue.LegacyForms,gt=e=>{const{derivedFields:t,className:a}=e,[s,n]=Object(Fe.useState)("");let i=[];return s&&t&&(i=function(e,t){return e.filter(e=>e.name&&e.matcherRegex).map(e=>{try{const a=t.match(e.matcherRegex),s=a&&a[1];let n=null;return e.url&&s&&(n=Object(ht.a)({field:{name:"",type:r.FieldType.string,values:new r.ArrayVector([s]),config:{links:[{title:"",url:e.url}]}},rowIndex:0,range:{}})[0]),{name:e.name,value:s||"<no match>",href:n&&n.href}}catch(t){return{name:e.name,error:t}}})}(t,s)),Object(Ie.jsxs)("div",{className:a,children:[Object(Ie.jsx)(pt,{labelWidth:12,label:"Debug log message",inputEl:Object(Ie.jsx)("textarea",{placeholder:"Paste an example log line here to test the regular expressions of your derived fields",className:mt()("gf-form-input gf-form-textarea",rt.css`
                width: 100%;
              `),value:s,onChange:e=>n(e.currentTarget.value)})}),!!i.length&&Object(Ie.jsx)(bt,{fields:i})]})},bt=({fields:e})=>Object(Ie.jsxs)("table",{className:"filter-table",children:[ut||(ut=Object(Ie.jsx)("thead",{children:Object(Ie.jsxs)("tr",{children:[Object(Ie.jsx)("th",{children:"Name"}),Object(Ie.jsx)("th",{children:"Value"}),Object(Ie.jsx)("th",{children:"Url"})]})})),Object(Ie.jsx)("tbody",{children:e.map(e=>{let t=e.value;return e.error?t=e.error.message:e.href&&(t=Object(Ie.jsx)("a",{href:e.href,children:t})),Object(Ie.jsxs)("tr",{children:[Object(Ie.jsx)("td",{children:e.name}),Object(Ie.jsx)("td",{children:t}),Object(Ie.jsx)("td",{children:e.href?Object(Ie.jsx)("a",{href:e.href,children:e.href}):""})]},`${e.name}=${e.value}`)})})]});var ft;const vt=e=>{const{value:t,onChange:a}=e,s=(e=>({infoText:rt.css`
    padding-bottom: ${e.spacing(2)};
    color: ${e.colors.text.secondary};
  `,derivedField:rt.css`
    margin-bottom: ${e.spacing(1)};
  `}))(Object(Ue.useTheme2)()),[n,i]=Object(Fe.useState)(!1);return Object(Ie.jsxs)(Ie.Fragment,{children:[ft||(ft=Object(Ie.jsx)("h3",{className:"page-heading",children:"Derived fields"})),Object(Ie.jsx)("div",{className:s.infoText,children:"Derived fields can be used to extract new fields from a log message and create a link from its value."}),Object(Ie.jsxs)("div",{className:"gf-form-group",children:[t&&t.map((e,n)=>Object(Ie.jsx)(ct,{className:s.derivedField,value:e,onChange:e=>{const r=[...t];r.splice(n,1,e),a(r)},onDelete:()=>{const e=[...t];e.splice(n,1),a(e)},suggestions:[{value:r.DataLinkBuiltInVars.valueRaw,label:"Raw value",documentation:"Exact string captured by the regular expression",origin:r.VariableOrigin.Value}]},n)),Object(Ie.jsxs)("div",{children:[Object(Ie.jsx)(Ue.Button,{variant:"secondary",className:rt.css`
              margin-right: 10px;
            `,icon:"plus",onClick:e=>{e.preventDefault();const r=[...t||[],{name:"",matcherRegex:""}];a(r)},children:"Add"}),t&&t.length>0&&Object(Ie.jsx)(Ue.Button,{variant:"secondary",type:"button",onClick:()=>i(!n),children:n?"Hide example log message":"Show example log message"})]})]}),n&&Object(Ie.jsx)("div",{className:"gf-form-group",children:Object(Ie.jsx)(gt,{className:rt.css`
              margin-bottom: 10px;
            `,derivedFields:t})})]})};function yt(){return(yt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const xt=e=>(t,a)=>yt({},t,{jsonData:yt({},t.jsonData,{[e]:a})}),jt=xt("maxLines"),Ot=xt("derivedFields");a.d(t,"plugin",(function(){return wt}));const wt=new r.DataSourcePlugin(Ce).setQueryEditor(Ge).setConfigEditor(e=>{const{options:t,onOptionsChange:a}=e;return Object(Ie.jsxs)(Ie.Fragment,{children:[Object(Ie.jsx)(Ue.DataSourceHttpSettings,{defaultUrl:"http://localhost:3100",dataSourceConfig:t,showAccessOptions:!1,onChange:a}),Object(Ie.jsx)(Ue.AlertingSettings,{options:t,onOptionsChange:a}),Object(Ie.jsx)("div",{className:"gf-form-group",children:Object(Ie.jsx)("div",{className:"gf-form-inline",children:Object(Ie.jsx)("div",{className:"gf-form",children:Object(Ie.jsx)(at,{value:t.jsonData.maxLines||"",onChange:e=>a(jt(t,e))})})})}),Object(Ie.jsx)(vt,{value:t.jsonData.derivedFields,onChange:e=>a(Ot(t,e))})]})}).setExploreQueryField(Ve).setQueryEditorHelp(Qe).setAnnotationQueryCtrl(et)},RKiO:function(e,t,a){"use strict";a.d(t,"c",(function(){return r})),a.d(t,"b",(function(){return s})),a.d(t,"a",(function(){return n}));const r=[{label:"json",insertText:"json",documentation:"Extracting labels from the log line using json parser. Only available in Loki 2.0+."},{label:"regexp",insertText:'regexp ""',documentation:"Extracting labels from the log line using regexp parser. Only available in Loki 2.0+.",move:-1},{label:"logfmt",insertText:"logfmt",documentation:"Extracting labels from the log line using logfmt parser. Only available in Loki 2.0+."},{label:"pattern",insertText:"pattern",documentation:"Extracting labels from the log line using pattern parser. Only available in Loki 2.3+."}],s=[{label:"unwrap",insertText:"unwrap",detail:"unwrap identifier",documentation:"Take labels and use the values as sample data for metric aggregations. Only available in Loki 2.0+."},{label:"label_format",insertText:"label_format",documentation:"Use to rename, modify or add labels. For example, | label_format foo=bar . Only available in Loki 2.0+."},{label:"line_format",insertText:"line_format",documentation:'Rewrites log line content. For example, | line_format "{{.query}} {{.duration}}" . Only available in Loki 2.0+.'}],n=[{label:"sum",insertText:"sum",documentation:"Calculate sum over dimensions"},{label:"min",insertText:"min",documentation:"Select minimum over dimensions"},{label:"max",insertText:"max",documentation:"Select maximum over dimensions"},{label:"avg",insertText:"avg",documentation:"Calculate the average over dimensions"},{label:"stddev",insertText:"stddev",documentation:"Calculate population standard deviation over dimensions"},{label:"stdvar",insertText:"stdvar",documentation:"Calculate population standard variance over dimensions"},{label:"count",insertText:"count",documentation:"Count number of elements in the vector"},{label:"bottomk",insertText:"bottomk",documentation:"Smallest k elements by sample value"},{label:"topk",insertText:"topk",documentation:"Largest k elements by sample value"},{insertText:"avg_over_time",label:"avg_over_time",detail:"avg_over_time(range-vector)",documentation:"The average of all values in the specified interval. Only available in Loki 2.0+."},{insertText:"min_over_time",label:"min_over_time",detail:"min_over_time(range-vector)",documentation:"The minimum of all values in the specified interval. Only available in Loki 2.0+."},{insertText:"max_over_time",label:"max_over_time",detail:"max_over_time(range-vector)",documentation:"The maximum of all values in the specified interval. Only available in Loki 2.0+."},{insertText:"sum_over_time",label:"sum_over_time",detail:"sum_over_time(range-vector)",documentation:"The sum of all values in the specified interval. Only available in Loki 2.0+."},{insertText:"count_over_time",label:"count_over_time",detail:"count_over_time(range-vector)",documentation:"The count of all values in the specified interval."},{insertText:"stdvar_over_time",label:"stdvar_over_time",detail:"stdvar_over_time(range-vector)",documentation:"The population standard variance of the values in the specified interval. Only available in Loki 2.0+."},{insertText:"stddev_over_time",label:"stddev_over_time",detail:"stddev_over_time(range-vector)",documentation:"The population standard deviation of the values in the specified interval. Only available in Loki 2.0+."},{insertText:"quantile_over_time",label:"quantile_over_time",detail:"quantile_over_time(scalar, range-vector)",documentation:"The φ-quantile (0 ≤ φ ≤ 1) of the values in the specified interval. Only available in Loki 2.0+."},{insertText:"bytes_over_time",label:"bytes_over_time",detail:"bytes_over_time(range-vector)",documentation:"Counts the amount of bytes used by each log stream for a given range"},{insertText:"bytes_rate",label:"bytes_rate",detail:"bytes_rate(range-vector)",documentation:"Calculates the number of bytes per second for each stream."},{insertText:"rate",label:"rate",detail:"rate(v range-vector)",documentation:"Calculates the per-second average rate of increase of the time series in the range vector. Breaks in monotonicity (such as counter resets due to target restarts) are automatically adjusted for. Also, the calculation extrapolates to the ends of the time range, allowing for missed scrapes or imperfect alignment of scrape cycles with the range's time period."}],i={comment:{pattern:/#.*/},"context-aggregation":{pattern:/((without|by)\s*)\([^)]*\)/,lookbehind:!0,inside:{"label-key":{pattern:/[^(),\s][^,)]*[^),\s]*/,alias:"attr-name"},punctuation:/[()]/}},"context-labels":{pattern:/\{[^}]*(?=}?)/,greedy:!0,inside:{comment:{pattern:/#.*/},"label-key":{pattern:/[a-z_]\w*(?=\s*(=|!=|=~|!~))/,alias:"attr-name",greedy:!0},"label-value":{pattern:/"(?:\\.|[^\\"])*"/,greedy:!0,alias:"attr-value"},punctuation:/[{]/}},"context-pipe":{pattern:/\s\|[^=~]\s?\w*/i,inside:{"pipe-operator":{pattern:/\|/i,alias:"operator"},"pipe-operations":{pattern:new RegExp(""+[...r,...s].map(e=>e.label).join("|"),"i"),alias:"keyword"}}},function:new RegExp(`\\b(?:${n.map(e=>e.label).join("|")})(?=\\s*\\()`,"i"),"context-range":[{pattern:/\[[^\]]*(?=\])/,inside:{"range-duration":{pattern:/\b\d+[smhdwy]\b/i,alias:"number"}}},{pattern:/(offset\s+)\w+/,lookbehind:!0,inside:{"range-duration":{pattern:/\b\d+[smhdwy]\b/i,alias:"number"}}}],number:/\b-?\d+((\.\d*)?([eE][+-]?\d+)?)?\b/,operator:/\s?(\|[=~]?|!=?|<(?:=>?|<|>)?|>[>=]?)\s?/i,punctuation:/[{}()`,.]/};t.d=i},tLXD:function(e,t,a){"use strict";var r=a("q1tI");t.a=function(e){var t=Object(r.useRef)();return Object(r.useEffect)((function(){t.current=e})),t.current}}}]);
//# sourceMappingURL=lokiPlugin.62c612232a976d8836f5.js.map