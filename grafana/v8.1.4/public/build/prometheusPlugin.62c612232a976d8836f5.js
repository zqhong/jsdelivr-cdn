(window.webpackJsonp=window.webpackJsonp||[]).push([[87],{EaOu:function(e,t,a){"use strict";a.r(t);var r=a("Obii"),s=a("t8hP"),n=a("m257"),i=a("NPB1"),l=a("5kRJ"),o=a("LvDl"),c=a("HyWp"),u=a.n(c),d=a("K9Ia"),h=a("F/XL"),p=a("y3By"),m=a("p0ib"),g=a("VNr4"),b=a("XlPw"),f=a("xMyE"),v=a("VnD/"),j=a("67Y/"),y=a("9Z1F"),x=a("eqT+"),O=a("48Ei"),S=a("ceQ3");function I(){return(I=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}var w=a("VphZ");function C(e){return"values"in e}const T=["__name__"];function _(){return(_=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function E(e,t){const a={format:t.target.format,step:t.query.step,legendFormat:t.target.legendFormat,start:t.query.start,end:t.query.end,query:t.query.expr,responseListLength:t.responseListLength,scopedVars:t.scopedVars,refId:t.target.refId,valueWithRefId:t.target.valueWithRefId,meta:{preferredVisualisationType:t.query.instant?"table":"graph"}},n=e.data.data;if(null!=(o=n)&&Array.isArray(o)&&o.length&&"exemplars"in o[0]){var i;const e=[];n.forEach(t=>{const a=t.exemplars.map(e=>_({[r.TIME_SERIES_TIME_FIELD_NAME]:1e3*e.timestamp,[r.TIME_SERIES_VALUE_FIELD_NAME]:e.value},e.labels,t.seriesLabels));e.push(...a)});const s=function(e,t){const a=t.step||15,s={},n=[];for(const t of e){const e=String(Math.floor(t[r.TIME_SERIES_TIME_FIELD_NAME]/1e3/a)*a*1e3);s[e]||(s[e]=[]),s[e].push(t),n.push(t[r.TIME_SERIES_VALUE_FIELD_NAME])}const i=Object(w.deviation)(n),l=Object.keys(s).sort(),o=[];for(const e of l){const t=s[e];if(1===t.length)o.push(t[0]);else{const e=t.map(e=>e[r.TIME_SERIES_VALUE_FIELD_NAME]).sort(w.descending).reduce((e,t)=>{if(0===e.length)e.push(t);else{const a=e[e.length-1];i&&a-t>=2*i&&e.push(t)}return e},[]);o.push(...e.map(e=>t.find(t=>t[r.TIME_SERIES_VALUE_FIELD_NAME]===e)))}}return o}(e,a),o=new r.ArrayDataFrame(s);if(o.meta={dataTopic:r.DataTopic.Annotations},null!==(i=t.exemplarTraceIdDestinations)&&void 0!==i&&i.length)for(const e of t.exemplarTraceIdDestinations){const t=o.fields.find(t=>t.name===e.name);if(t){var l;const a=q(e);t.config.links=null!==(l=t.config.links)&&void 0!==l&&l.length?[...t.config.links,...a]:a}}return[o]}var o;if(null==n||!n.result)return[];if("scalar"===n.resultType)return[{meta:a.meta,refId:a.refId,length:1,fields:[P([n.result]),D({data:[n.result]})]}];if("table"===a.format){return[function(e,t){if(!e||0===e.length)return{meta:t.meta,refId:t.refId,length:0,fields:[]};const a=t.responseListLength>1||t.valueWithRefId?"Value #"+t.refId:"Value",s=P([]),n=Object.keys(e.reduce((e,t)=>_({},e,t.metric),{})).sort().map(e=>({name:e,config:{filterable:!0},type:"le"===e?r.FieldType.number:r.FieldType.string,values:new r.ArrayVector})),i=D({data:[],valueName:a});return e.forEach(e=>{C(e)?e.values.forEach(t=>{s.values.add(1e3*t[0]),n.forEach(t=>t.values.add(N(e.metric,t.name))),i.values.add(k(t[1]))}):(s.values.add(1e3*e.value[0]),n.forEach(t=>t.values.add(N(e.metric,t.name))),i.values.add(k(e.value[1])))}),{meta:t.meta,refId:t.refId,length:s.values.length,fields:[s,...n,i]}}(n.result,a)]}const c=[];if(n.result.forEach(e=>c.push(function(e,t){const{name:a,labels:n}=function(e,t){if(null!=t&&t.legendFormat){return{name:L(Object(s.getTemplateSrv)().replace(t.legendFormat,null==t?void 0:t.scopedVars),e),labels:e}}const{__name__:a}=e,n=function(e,t){if(null==e)return{};var a,r,s={},n=Object.keys(e);for(r=0;r<n.length;r++)a=n[r],t.indexOf(a)>=0||(s[a]=e[a]);return s}(e,T),i=Object(r.formatLabels)(n);let l=`${null!=a?a:""}${i}`;l||(l=t.query);return{name:l,labels:n}}(e.metric,t),i=[];if(C(e)){const r=t.step?1e3*t.step:NaN;let s=1e3*t.start;const l=[];for(const t of e.values){let e=k(t[1]);isNaN(e)&&(e=null);const a=1e3*t[0];for(let e=s;e<a;e+=r)l.push([e,null]);s=a+r,l.push([a,e])}const o=1e3*t.end;for(let e=s;e<=o;e+=r)l.push([e,null]);i.push(P(l,!0)),i.push(D({data:l,parseValue:!1,labels:n,displayNameFromDS:a}))}else i.push(P([e.value])),i.push(D({data:[e.value],labels:n,displayNameFromDS:a}));return{meta:t.meta,refId:t.refId,length:i[0].values.length,fields:i,name:a}}(e,a))),"heatmap"===a.format){c.sort(F);return function(e){for(let t=e.length-1;t>0;t--){const a=e[t].fields.find(e=>e.name===r.TIME_SERIES_VALUE_FIELD_NAME),s=e[t-1].fields.find(e=>e.name===r.TIME_SERIES_VALUE_FIELD_NAME);if(!a||!s)throw new Error("Prometheus heatmap transform error: data should be a time series");for(let e=0;e<a.values.length;e++){const t=s.values.get(e)||[0];a.values.toArray()[e]-=t}}return e}(c)}return c}function q(e){const t=[];if(e.datasourceUid){var a;const r=Object(s.getDataSourceSrv)().getInstanceSettings(e.datasourceUid);t.push({title:"Query with "+(null==r?void 0:r.name),url:"",internal:{query:{query:"${__value.raw}",queryType:"traceId"},datasourceUid:e.datasourceUid,datasourceName:null!==(a=null==r?void 0:r.name)&&void 0!==a?a:"Data source not found"}})}return e.url&&t.push({title:"Go to "+e.url,url:e.url,targetBlank:!0}),t}function N(e,t){return e.hasOwnProperty(t)?"le"===t?k(e[t]):e[t]:""}function P(e,t=!1){return{name:r.TIME_SERIES_TIME_FIELD_NAME,type:r.FieldType.time,config:{},values:new r.ArrayVector(e.map(e=>t?e[0]:1e3*e[0]))}}function D({data:e,valueName:t=r.TIME_SERIES_VALUE_FIELD_NAME,parseValue:a=!0,labels:s,displayNameFromDS:n}){return{name:t,type:r.FieldType.number,display:Object(r.getDisplayProcessor)(),config:{displayNameFromDS:n},labels:s,values:new r.ArrayVector(e.map(e=>a?k(e[1]):e[1]))}}function L(e,t){return e.replace(/\{\{\s*(.+?)\s*\}\}/g,(e,a)=>t[a]?t[a]:"")}function F(e,t){let a,r;try{var s,n;a=k(null!==(s=e.name)&&void 0!==s?s:""),r=k(null!==(n=t.name)&&void 0!==n?n:"")}catch(e){return console.error(e),0}return a>r?1:a<r?-1:0}function k(e){switch(e){case"+Inf":return Number.POSITIVE_INFINITY;case"-Inf":return Number.NEGATIVE_INFINITY;default:return parseFloat(e)}}var R=a("0/uQ");class A{constructor(e,t){var a,r,s;s=void 0,(r="range")in(a=this)?Object.defineProperty(a,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):a[r]=s,this.datasource=e,this.query=t,this.datasource=e,this.query=t,this.range=Object(i.a)().timeRange()}process(){if(this.query.match(/^label_names\(\)\s*$/))return this.labelNamesQuery();const e=this.query.match(/^label_values\((?:(.+),\s*)?([a-zA-Z_][a-zA-Z0-9_]*)\)\s*$/);if(e)return e[1]?this.labelValuesQuery(e[2],e[1]):this.labelValuesQuery(e[2]);const t=this.query.match(/^metrics\((.+)\)\s*$/);if(t)return this.metricNameQuery(t[1]);const a=this.query.match(/^query_result\((.+)\)\s*$/);return a?this.queryResultQuery(a[1]).toPromise():this.metricNameAndLabelsQuery(this.query)}labelNamesQuery(){const e=this.datasource.getPrometheusTime(this.range.from,!1),t=this.datasource.getPrometheusTime(this.range.to,!0),a={start:e.toString(),end:t.toString()};return this.datasource.metadataRequest("/api/v1/labels",a).then(e=>Object(o.map)(e.data.data,e=>({text:e})))}labelValuesQuery(e,t){const a=this.datasource.getPrometheusTime(this.range.from,!1),r=this.datasource.getPrometheusTime(this.range.to,!0);let s;if(t){const n={"match[]":t,start:a.toString(),end:r.toString()};return s="/api/v1/series",this.datasource.metadataRequest(s,n).then(t=>{const a=Object(o.map)(t.data.data,t=>t[e]||"").filter(e=>""!==e);return Object(o.uniq)(a).map(e=>({text:e,expandable:!0}))})}{const t={start:a.toString(),end:r.toString()};return s=`/api/v1/label/${e}/values`,this.datasource.metadataRequest(s,t).then(e=>Object(o.map)(e.data.data,e=>({text:e})))}}metricNameQuery(e){const t=this.datasource.getPrometheusTime(this.range.from,!1),a=this.datasource.getPrometheusTime(this.range.to,!0),r={start:t.toString(),end:a.toString()};return this.datasource.metadataRequest("/api/v1/label/__name__/values",r).then(t=>Object(o.chain)(t.data.data).filter(t=>new RegExp(e).test(t)).map(e=>({text:e,expandable:!0})).value())}queryResultQuery(e){const t=this.datasource.getPrometheusTime(this.range.to,!0),a={expr:e};return this.datasource.performInstantQuery(a,t).pipe(Object(j.a)(e=>Object(o.map)(e.data.data.result,e=>{let t=e.metric.__name__||"";return delete e.metric.__name__,t+="{"+Object(o.map)(e.metric,(e,t)=>t+'="'+e+'"').join(",")+"}",t+=" "+e.value[1]+" "+1e3*e.value[0],{text:t,expandable:!0}})))}metricNameAndLabelsQuery(e){const t=this.datasource.getPrometheusTime(this.range.from,!1),a=this.datasource.getPrometheusTime(this.range.to,!0),r={"match[]":e,start:t.toString(),end:a.toString()},s=this;return this.datasource.metadataRequest("/api/v1/series",r).then(e=>Object(o.map)(e.data.data,e=>({text:s.datasource.getOriginalMetricName(e),expandable:!0})))}}function X(){return(X=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}class Q extends r.StandardVariableSupport{constructor(e,t=Object(s.getTemplateSrv)(),a=Object(i.a)()){super(),this.datasource=e,this.templateSrv=t,this.timeSrv=a,this.query=this.query.bind(this)}query(e){const t=e.targets[0].expr;if(!t)return Object(h.a)({data:[]});const a=X({},e.scopedVars,{__interval:{text:this.datasource.interval,value:this.datasource.interval},__interval_ms:{text:r.rangeUtil.intervalToMs(this.datasource.interval),value:r.rangeUtil.intervalToMs(this.datasource.interval)}},this.datasource.getRangeScopedVars(this.timeSrv.timeRange())),s=this.templateSrv.replace(t,a,this.datasource.interpolateQueryExpr),n=new A(this.datasource,s);return Object(R.a)(n.process()).pipe(Object(j.a)(e=>({data:e})))}toDataQuery(e){return{refId:"PrometheusDatasource-VariableQuery",expr:e.query}}}function M(){return(M=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function $(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}const V=["api/v1/query","api/v1/query_range","api/v1/series","api/v1/labels"];class U extends r.DataSourceApi{constructor(e,t=Object(l.a)(),a=Object(i.a)()){var s;super(e),$(this,"type",void 0),$(this,"editorSrc",void 0),$(this,"ruleMappings",void 0),$(this,"url",void 0),$(this,"directUrl",void 0),$(this,"basicAuth",void 0),$(this,"withCredentials",void 0),$(this,"metricsNameCache",new u.a(10)),$(this,"interval",void 0),$(this,"queryTimeout",void 0),$(this,"httpMethod",void 0),$(this,"languageProvider",void 0),$(this,"exemplarTraceIdDestinations",void 0),$(this,"lookupsDisabled",void 0),$(this,"customQueryParameters",void 0),$(this,"exemplarErrors",new d.b),$(this,"init",()=>{this.loadRules()}),$(this,"prepareTargets",(e,t,a)=>{const s=[],n=[],i=Object(o.cloneDeep)(e.targets);for(const l of i){if(!l.expr||l.hide)continue;l.requestId=e.panelId+l.refId;const i=this.languageProvider.histogramMetrics.find(e=>l.expr.includes(e));if(e.app===r.CoreApp.Explore&&l.range===l.instant){const r=Object(o.cloneDeep)(l);r.format="table",r.instant=!0,r.range=!1,r.valueWithRefId=!0,delete r.maxDataPoints,r.requestId+="_instant";const c=Object(o.cloneDeep)(l);if(c.format="time_series",c.instant=!1,r.range=!0,l.exemplar){if(!i||i&&!n.some(e=>e.expr.includes(i))){const r=Object(o.cloneDeep)(l);r.instant=!1,r.requestId+="_exemplar",s.push(this.createQuery(r,e,t,a)),n.push(r)}r.exemplar=!1,c.exemplar=!1}n.push(r,c),s.push(this.createQuery(r,e,t,a),this.createQuery(c,e,t,a))}else if(l.instant&&e.app===r.CoreApp.Explore){const r=Object(o.cloneDeep)(l);r.format="table",s.push(this.createQuery(r,e,t,a)),n.push(r)}else{if(l.exemplar&&!l.instant){if(!i||i&&!n.some(e=>e.expr.includes(i))){const r=Object(o.cloneDeep)(l);r.requestId+="_exemplar",s.push(this.createQuery(r,e,t,a)),n.push(r),this.exemplarErrors.next({refId:r.refId,error:null})}l.exemplar=!1}l.exemplar&&l.instant&&this.exemplarErrors.next({refId:l.refId,error:"Exemplars are not available for instant queries."}),s.push(this.createQuery(l,e,t,a)),n.push(l)}}return{queries:s,activeTargets:n}}),$(this,"handleErrors",(e,t)=>{const a={message:e&&e.statusText||"Unknown error during query transaction. Please check JS console logs.",refId:t.refId};return e.data?"string"==typeof e.data?a.message=e.data:e.data.error&&(a.message=Object(n.q)(e.data.error)):e.message?a.message=e.message:"string"==typeof e&&(a.message=e),a.status=e.status,a.statusText=e.statusText,a}),$(this,"createAnnotationQueryOptions",e=>{const t=e.annotation;return M({},e,{interval:t&&t.step&&"string"==typeof t.step?t.step:"60s"})}),this.templateSrv=t,this.timeSrv=a,this.type="prometheus",this.editorSrc="app/features/prometheus/partials/query.editor.html",this.url=e.url,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.interval=e.jsonData.timeInterval||"15s",this.queryTimeout=e.jsonData.queryTimeout,this.httpMethod=e.jsonData.httpMethod||"POST",this.directUrl=e.jsonData.directUrl,this.exemplarTraceIdDestinations=e.jsonData.exemplarTraceIdDestinations,this.ruleMappings={},this.languageProvider=new O.b(this),this.lookupsDisabled=null!==(s=e.jsonData.disableMetricsLookup)&&void 0!==s&&s,this.customQueryParameters=new URLSearchParams(e.jsonData.customQueryParameters),this.variables=new Q(this,this.templateSrv,this.timeSrv)}getQueryDisplayText(e){return e.expr}_addTracingHeaders(e,t){e.headers={};!this.url.match(/^http/)&&(e.headers["X-Dashboard-Id"]=t.dashboardId,e.headers["X-Panel-Id"]=t.panelId)}_request(e,t,a={}){t=t||{};for(const[e,a]of this.customQueryParameters)null==t[e]&&(t[e]=a);const r=Object(o.defaults)(a,{url:this.url+e,method:this.httpMethod,headers:{}});return"GET"===r.method?t&&Object.keys(t).length&&(r.url=r.url+(r.url.search(/\?/)>=0?"&":"?")+Object.entries(t).map(([e,t])=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`).join("&")):(r.headers["Content-Type"]="application/x-www-form-urlencoded",r.data=t),(this.basicAuth||this.withCredentials)&&(r.withCredentials=!0),this.basicAuth&&(r.headers.Authorization=this.basicAuth),Object(s.getBackendSrv)().fetch(r)}async metadataRequest(e,t={}){if(V.some(t=>e.includes(t)))try{return await this._request(e,t,{method:this.httpMethod,hideFromInspector:!0}).toPromise()}catch(e){if("POST"!==this.httpMethod||405!==e.status)throw e;console.warn("Couldn't use configured POST HTTP method for this request. Trying to use GET method instead.")}return await this._request(e,t,{method:"GET",hideFromInspector:!0}).toPromise()}interpolateQueryExpr(e=[],t){if(!t.multi&&!t.includeAll)return z(e);if("string"==typeof e)return B(e);const a=e.map(e=>B(e));return 1===a.length?a[0]:"("+a.join("|")+")"}targetContainsTemplate(e){return this.templateSrv.variableExists(e.expr)}query(e){const t=this.getPrometheusTime(e.range.from,!1),a=this.getPrometheusTime(e.range.to,!0),{queries:s,activeTargets:n}=this.prepareTargets(e,t,a);return s&&s.length?e.app===r.CoreApp.Explore?this.exploreQuery(s,n,a):this.panelsQuery(s,n,a,e.requestId,e.scopedVars):Object(h.a)({data:[],state:r.LoadingState.Done})}exploreQuery(e,t,a){let s=e.length;const n=e.map((n,i)=>{const l=t[i],o=Object(p.a)(Object(f.a)(()=>s--),Object(v.a)(e=>!e.cancelled),Object(j.a)(t=>({data:E(t,{query:n,target:l,responseListLength:e.length,exemplarTraceIdDestinations:this.exemplarTraceIdDestinations}),key:n.requestId,state:0===s?r.LoadingState.Done:r.LoadingState.Loading})));return this.runQuery(n,a,o)});return Object(m.a)(...n)}panelsQuery(e,t,a,s,n){const i=e.map((r,s)=>{const i=t[s],l=Object(p.a)(Object(v.a)(e=>!e.cancelled),Object(j.a)(t=>E(t,{query:r,target:i,responseListLength:e.length,scopedVars:n,exemplarTraceIdDestinations:this.exemplarTraceIdDestinations})));return this.runQuery(r,a,l)});return Object(g.a)(i).pipe(Object(j.a)(e=>({data:e.reduce((e,t)=>[...e,...t],[]),key:s,state:r.LoadingState.Done})))}runQuery(e,t,a){return e.instant?this.performInstantQuery(e,t).pipe(a):e.exemplar?this.getExemplars(e).pipe(Object(y.a)(()=>(this.exemplarErrors.next({refId:e.refId,error:"Exemplars for this query are not available."}),Object(h.a)({data:[],state:r.LoadingState.Done}))),a):this.performTimeSeriesQuery(e,e.start,e.end).pipe(a)}createQuery(e,t,a,s){const n={hinting:e.hinting,instant:e.instant,exemplar:e.exemplar,step:0,expr:"",requestId:e.requestId,refId:e.refId,start:0,end:0},i=Math.ceil(s-a);let l=r.rangeUtil.intervalToSeconds(t.interval);const o=r.rangeUtil.intervalToSeconds(this.templateSrv.replace(e.interval||t.interval,t.scopedVars)),c=e.interval?r.rangeUtil.intervalToSeconds(this.templateSrv.replace(e.interval,t.scopedVars)):r.rangeUtil.intervalToSeconds(this.interval),u=e.intervalFactor||1,d=this.adjustInterval(l,o,i,u);let h=M({},t.scopedVars,this.getRangeScopedVars(t.range),this.getRateIntervalScopedVariable(d,c));l!==d&&(l=d,h=Object.assign({},t.scopedVars,M({__interval:{text:l+"s",value:l+"s"},__interval_ms:{text:1e3*l,value:1e3*l}},this.getRateIntervalScopedVariable(l,c),this.getRangeScopedVars(t.range)))),n.step=l;let p=e.expr;p=this.templateSrv.getAdhocFilters(this.name).reduce((e,t)=>{const{key:a,operator:r}=t;let{value:s}=t;return"=~"!==r&&"!~"!==r||(s=z(s)),Object(x.b)(e,a,s,r)},p),n.expr=this.templateSrv.replace(p,h,this.interpolateQueryExpr);const m=function(e,t,a,r){const s=Math.floor((t+r)/a)*a-r,n=Math.floor((e+r)/a)*a-r;return{end:s,start:n}}(a,s,n.step,60*this.timeSrv.timeRange().to.utcOffset());return n.start=m.start,n.end=m.end,this._addTracingHeaders(n,t),n}getRateIntervalScopedVariable(e,t){0===t&&(t=15);const a=Math.max(e+t,4*t);return{__rate_interval:{text:a+"s",value:a+"s"}}}adjustInterval(e,t,a,r){let s=a/11e3;return s>1&&(s=Math.ceil(s)),Math.max(e*r,t,s)}performTimeSeriesQuery(e,t,a){if(t>a)throw{message:"Invalid time range"};const r={query:e.expr,start:t,end:a,step:e.step};return this.queryTimeout&&(r.timeout=this.queryTimeout),this._request("/api/v1/query_range",r,{requestId:e.requestId,headers:e.headers}).pipe(Object(y.a)(t=>t.cancelled?Object(h.a)(t):Object(b.a)(this.handleErrors(t,e))))}performInstantQuery(e,t){const a={query:e.expr,time:t};return this.queryTimeout&&(a.timeout=this.queryTimeout),this._request("/api/v1/query",a,{requestId:e.requestId,headers:e.headers}).pipe(Object(y.a)(t=>t.cancelled?Object(h.a)(t):Object(b.a)(this.handleErrors(t,e))))}metricFindQuery(e){if(!e)return Promise.resolve([]);const t=M({__interval:{text:this.interval,value:this.interval},__interval_ms:{text:r.rangeUtil.intervalToMs(this.interval),value:r.rangeUtil.intervalToMs(this.interval)}},this.getRangeScopedVars(this.timeSrv.timeRange())),a=this.templateSrv.replace(e,t,this.interpolateQueryExpr);return new A(this,a).process()}getRangeScopedVars(e=this.timeSrv.timeRange()){const t=e.to.diff(e.from),a=Math.round(t/1e3);return{__range_ms:{text:t,value:t},__range_s:{text:a,value:a},__range:{text:a+"s",value:a+"s"}}}async annotationQuery(e){var t,a,r,s;const n=e.annotation,{expr:i="",tagKeys:l="",titleFormat:o="",textFormat:c=""}=n;if(!i)return Promise.resolve([]);const u=this.getPrometheusTime(e.range.from,!1),d=this.getPrometheusTime(e.range.to,!0),h=this.createAnnotationQueryOptions(e),p={expr:i,interval:"1s",refId:"X",requestId:"prom-query-"+n.name},m=this.createQuery(p,h,u,d),g=await this.performTimeSeriesQuery(m,m.start,m.end).toPromise(),b=[],f=l.split(",");if(function(e){return"cancelled"in e}(g)&&g.cancelled)return[];const v=1e3*Math.floor(null!==(t=m.step)&&void 0!==t?t:15);return null==g||null===(a=g.data)||void 0===a||null===(r=a.data)||void 0===r||null===(s=r.result)||void 0===s||s.forEach(e=>{const t=Object.entries(e.metric).filter(([e])=>f.includes(e)).map(([e,t])=>t);e.values.forEach(e=>{let t;n.useValueForTime?(t=Math.floor(parseFloat(e[1])),e[1]=1):t=1e3*Math.floor(parseFloat(e[0])),e[0]=t});const a=e.values.filter(e=>parseFloat(e[1])>=1).map(e=>e[0]);let r=null;for(const i of a){var s;r&&(null!==(s=r.timeEnd)&&void 0!==s?s:0)+v>=i?r.timeEnd=i:(r&&b.push(r),r={time:i,timeEnd:i,annotation:n,title:L(o,e.metric),tags:t,text:L(c,e.metric)})}r&&(r.timeEnd=a[a.length-1],b.push(r))}),b}getExemplars(e){return this._request("/api/v1/query_exemplars",{query:e.expr,start:e.start.toString(),end:e.end.toString()},{requestId:e.requestId,headers:e.headers})}async getTagKeys(){var e,t,a;const r=await this.metadataRequest("/api/v1/labels");return null!==(e=null==r||null===(t=r.data)||void 0===t||null===(a=t.data)||void 0===a?void 0:a.map(e=>({text:e})))&&void 0!==e?e:[]}async getTagValues(e={}){var t,a,r;const s=await this.metadataRequest(`/api/v1/label/${e.key}/values`);return null!==(t=null==s||null===(a=s.data)||void 0===a||null===(r=a.data)||void 0===r?void 0:r.map(e=>({text:e})))&&void 0!==t?t:[]}async testDatasource(){const e=(new Date).getTime(),t=await this.performInstantQuery({expr:"1+1"},e/1e3).toPromise();return"success"===t.data.status?{status:"success",message:"Data source is working"}:{status:"error",message:t.data.error}}interpolateVariablesInQueries(e,t){let a=e;return e&&e.length&&(a=e.map(e=>M({},e,{datasource:this.name,expr:this.templateSrv.replace(e.expr,t,this.interpolateQueryExpr),interval:this.templateSrv.replace(e.interval,t)}))),a}getQueryHints(e,t){var a;return function(e,t,a){const r=[];if(e.trim().match(/^\w+_bucket$/)){const t="Time series has buckets, you probably wanted a histogram.";r.push({type:"HISTOGRAM_QUANTILE",label:t,fix:{label:"Fix by adding histogram_quantile().",action:{type:"ADD_HISTOGRAM_QUANTILE",query:e}}})}if(-1===e.indexOf("rate(")&&-1===e.indexOf("increase(")){var s,n;const t=e.match(/\b(\w+_(total|sum|count))\b/);let l=t?t[1]:"";const o=null!==(s=null==a||null===(n=a.languageProvider)||void 0===n?void 0:n.metricsMetadata)&&void 0!==s?s:{},c=Object.keys(o);let u=!1;var i;if(c.length>0)l=null!==(i=c.find(t=>{if("counter"===o[t][0].type.toLowerCase()){const a=new RegExp(`\\b${t}\\b`);if(e.match(a))return u=!0,!0}return!1}))&&void 0!==i?i:"";if(l){const t=e.trim().match(/^\w+$/);let a,s=`Metric ${l} ${u?"is":"looks like"} a counter.`;t?a={label:"Fix by adding rate().",action:{type:"ADD_RATE",query:e}}:s+=" Try applying a rate() function.",r.push({type:"APPLY_RATE",label:s,fix:a})}}if(a&&a.ruleMappings){const t=a.ruleMappings,s=Object.keys(t).reduce((a,r)=>e.search(r)>-1?I({},a,{[r]:t[r]}):a,{});if(Object(o.size)(s)>0){const t="Query contains recording rules.";r.push({type:"EXPAND_RULES",label:t,fix:{label:"Expand rules",action:{type:"EXPAND_RULES",query:e,mapping:s}}})}}if(t&&t.length>=20){e.trim().match(/^\w+$/)&&r.push({type:"ADD_SUM",label:"Many time series results returned.",fix:{label:"Consider aggregating with sum().",action:{type:"ADD_SUM",query:e,preventSubmit:!0}}})}return r}(null!==(a=e.expr)&&void 0!==a?a:"",t,this)}getInitHints(){return function(e){const t=[];return e.directUrl.includes("/loki")&&!e.languageProvider.metrics.length&&t.push({label:"Using Loki as a Prometheus data source is no longer supported. You must use the Loki data source for your Loki instance.",type:"INFO"}),e.lookupsDisabled&&t.push({label:"Labels and metrics lookup was disabled in data source settings.",type:"INFO"}),t}(this)}async loadRules(){try{var e,t;const a=null===(e=(await this.metadataRequest("/api/v1/rules")).data)||void 0===e||null===(t=e.data)||void 0===t?void 0:t.groups;a&&(this.ruleMappings=function(e){return e.reduce((e,t)=>t.rules.filter(e=>"recording"===e.type).reduce((e,t)=>M({},e,{[t.name]:t.query}),e),{})}(a))}catch(e){console.log("Rules API is experimental. Ignore next error."),console.error(e)}}modifyQuery(e,t){var a;let r=null!==(a=e.expr)&&void 0!==a?a:"";switch(t.type){case"ADD_FILTER":r=Object(x.b)(r,t.key,t.value);break;case"ADD_FILTER_OUT":r=Object(x.b)(r,t.key,t.value,"!=");break;case"ADD_HISTOGRAM_QUANTILE":r=`histogram_quantile(0.95, sum(rate(${r}[5m])) by (le))`;break;case"ADD_RATE":r=`rate(${r}[5m])`;break;case"ADD_SUM":r=`sum(${r.trim()}) by ($1)`;break;case"EXPAND_RULES":t.mapping&&(r=Object(S.b)(r,t.mapping))}return M({},e,{expr:r})}getPrometheusTime(e,t){return"string"==typeof e&&(e=r.dateMath.parse(e,t)),Math.ceil(e.valueOf()/1e3)}getTimeRangeParams(){const e=this.timeSrv.timeRange();return{start:this.getPrometheusTime(e.from,!1).toString(),end:this.getPrometheusTime(e.to,!0).toString()}}getOriginalMetricName(e){return function(e){const t=e.__name__||"";return delete e.__name__,`${t}{${Object.entries(e).map(e=>`${e[0]}="${e[1]}"`).join(",")}}`}(e)}}function z(e){return"string"==typeof e?e.replace(/\\/g,"\\\\").replace(/'/g,"\\\\'"):e}function B(e){return"string"==typeof e?e.replace(/\\/g,"\\\\\\\\").replace(/[$^*{}\[\]\'+?.()|]/g,"\\\\$&"):e}var H=a("q1tI"),G=a.n(H),W=a("kDLi"),K=a("wZee");var J=a("vF1F"),Y=a("SMGL"),Z=a("iR1w"),ee=a("WG1l"),te=a.n(ee),ae=a("nKUr");const re=["name","value","hidden","facets","onClick","className","loading","searchTerm","active","style","title"];function se(){return(se=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const ne=Object(H.forwardRef)((e,t)=>{let{name:a,value:r,hidden:s,facets:n,onClick:i,className:l,loading:o,searchTerm:c,active:u,style:d,title:h}=e,p=function(e,t){if(null==e)return{};var a,r,s={},n=Object.keys(e);for(r=0;r<n.length;r++)a=n[r],t.indexOf(a)>=0||(s[a]=e[a]);return s}(e,re);const m=Object(W.useTheme2)(),g=ie(m),b=c?[c]:[];let f=r||a;return n&&(f=`${f} (${n})`),Object(ae.jsx)("span",se({ref:t,onClick:e=>{i&&!s&&i(a,r,e)},style:d,title:h||f,role:"option","aria-selected":!!u,className:Object(J.cx)(g.base,u&&g.active,o&&g.loading,s&&g.hidden,l,i&&!s&&g.hover)},p,{children:Object(ae.jsx)(te.a,{textToHighlight:f,searchWords:b,autoEscape:!0,highlightClassName:g.matchHighLight})}),f)});ne.displayName="Label";const ie=e=>({base:J.css`
    cursor: pointer;
    font-size: ${e.typography.size.sm};
    line-height: ${e.typography.bodySmall.lineHeight};
    background-color: ${e.colors.background.secondary};
    vertical-align: baseline;
    color: ${e.colors.text};
    white-space: nowrap;
    text-shadow: none;
    padding: ${e.spacing(.5)};
    border-radius: ${e.shape.borderRadius()};
    margin-right: ${e.spacing(1)};
    margin-bottom: ${e.spacing(.5)};
  `,loading:J.css`
    font-weight: ${e.typography.fontWeightMedium};
    background-color: ${e.colors.primary.shade};
    color: ${e.colors.text.primary};
    animation: pulse 3s ease-out 0s infinite normal forwards;
    @keyframes pulse {
      0% {
        color: ${e.colors.text.primary};
      }
      50% {
        color: ${e.colors.text.secondary};
      }
      100% {
        color: ${e.colors.text.disabled};
      }
    }
  `,active:J.css`
    font-weight: ${e.typography.fontWeightMedium};
    background-color: ${e.colors.primary.main};
    color: ${e.colors.primary.contrastText};
  `,matchHighLight:J.css`
    background: inherit;
    color: ${e.colors.primary.text};
    background-color: ${e.colors.primary.transparent};
  `,hidden:J.css`
    opacity: 0.6;
    cursor: default;
    border: 1px solid transparent;
  `,hover:J.css`
    &:hover {
      opacity: 0.85;
      cursor: pointer;
    }
  `});var le,oe,ce,ue,de;function he(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function pe(){return(pe=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const me="grafana.datasources.prometheus.browser.labels";function ge(e){let t="";const a=[];for(const r of e)if(("__name__"===r.name||r.selected)&&r.values&&r.values.length>0){const e=r.values.filter(e=>e.selected).map(e=>e.name);e.length>1?a.push(`${r.name}=~"${e.join("|")}"`):1===e.length&&("__name__"===r.name?t=e[0]:a.push(`${r.name}="${e[0]}"`))}return[t,"{",a.join(","),"}"].join("")}const be=Object(W.stylesFactory)(e=>({wrapper:J.css`
    background-color: ${e.colors.bg2};
    padding: ${e.spacing.sm};
    width: 100%;
  `,list:J.css`
    margin-top: ${e.spacing.sm};
    display: flex;
    flex-wrap: wrap;
    max-height: 200px;
    overflow: auto;
    align-content: flex-start;
  `,section:J.css`
    & + & {
      margin: ${e.spacing.md} 0;
    }
    position: relative;
  `,selector:J.css`
    font-family: ${e.typography.fontFamily.monospace};
    margin-bottom: ${e.spacing.sm};
  `,status:J.css`
    padding: ${e.spacing.xs};
    color: ${e.colors.textSemiWeak};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    /* using absolute positioning because flex interferes with ellipsis */
    position: absolute;
    width: 50%;
    right: 0;
    text-align: right;
    transition: opacity 100ms linear;
    opacity: 0;
  `,statusShowing:J.css`
    opacity: 1;
  `,error:J.css`
    color: ${e.palette.brandDanger};
  `,valueList:J.css`
    margin-right: ${e.spacing.sm};
  `,valueListWrapper:J.css`
    border-left: 1px solid ${e.colors.border2};
    margin: ${e.spacing.sm} 0;
    padding: ${e.spacing.sm} 0 ${e.spacing.sm} ${e.spacing.sm};
  `,valueListArea:J.css`
    display: flex;
    flex-wrap: wrap;
    margin-top: ${e.spacing.sm};
  `,valueTitle:J.css`
    margin-left: -${e.spacing.xs};
    margin-bottom: ${e.spacing.sm};
  `,validationStatus:J.css`
    padding: ${e.spacing.xs};
    margin-bottom: ${e.spacing.sm};
    color: ${e.colors.textStrong};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  `}));class fe extends G.a.Component{constructor(...e){super(...e),he(this,"valueListsRef",G.a.createRef()),he(this,"state",{labels:[],labelSearchTerm:"",metricSearchTerm:"",status:"Ready",error:"",validationStatus:"",valueSearchTerm:""}),he(this,"onChangeLabelSearch",e=>{this.setState({labelSearchTerm:e.target.value})}),he(this,"onChangeMetricSearch",e=>{this.setState({metricSearchTerm:e.target.value})}),he(this,"onChangeValueSearch",e=>{this.setState({valueSearchTerm:e.target.value})}),he(this,"onClickRunQuery",()=>{const e=ge(this.state.labels);this.props.onChange(e)}),he(this,"onClickRunRateQuery",()=>{const e=`rate(${ge(this.state.labels)}[$__interval])`;this.props.onChange(e)}),he(this,"onClickClear",()=>{this.setState(e=>({labels:e.labels.map(e=>pe({},e,{values:void 0,selected:!1,loading:!1,hidden:!1,facets:void 0})),labelSearchTerm:"",metricSearchTerm:"",status:"",error:"",validationStatus:"",valueSearchTerm:""})),Y.a.delete(me),this.fetchValues("__name__","{}")}),he(this,"onClickLabel",(e,t,a)=>{const r=this.state.labels.find(t=>t.name===e);if(!r)return;const s=!r.selected;let n={selected:s};if(r.values&&!s){const e=r.values.map(e=>pe({},e,{selected:!1}));n=pe({},n,{facets:0,values:e})}this.setState({labelSearchTerm:""}),this.updateLabelState(e,n,"",()=>this.doFacettingForLabel(e))}),he(this,"onClickValue",(e,t,a)=>{const r=this.state.labels.find(t=>t.name===e);if(!r||!r.values)return;this.setState({labelSearchTerm:""});const s=r.values.map(e=>pe({},e,{selected:e.name===t?!e.selected:e.selected}));this.updateLabelState(e,{values:s},"",()=>this.doFacetting(e))}),he(this,"onClickMetric",(e,t,a)=>{const r=this.state.labels.find(t=>t.name===e);if(!r||!r.values)return;this.setState({metricSearchTerm:""});const s=r.values.map(e=>pe({},e,{selected:e.name===t||e.selected?!e.selected:e.selected})),n=s.some(e=>e.selected);this.updateLabelState(e,{selected:n,values:s},"",()=>this.doFacetting(e))}),he(this,"onClickValidate",()=>{const e=ge(this.state.labels);this.validateSelector(e)}),he(this,"doFacetting",e=>{const t=ge(this.state.labels);if("{}"===t){const e=this.state.labels.map(e=>pe({},e,{facets:0,values:void 0,hidden:!1}));this.setState({labels:e},()=>{this.state.labels.forEach(e=>(e.selected||"__name__"===e.name)&&this.fetchValues(e.name,t))})}else this.fetchSeries(t,e)})}updateLabelState(e,t,a="",r){this.setState(r=>{const s=r.labels.map(a=>a.name===e?pe({},a,t):a),n=a?"":r.error;return{labels:s,status:a,error:n,validationStatus:""}},r)}componentDidMount(){const{languageProvider:e}=this.props;if(e){const t=Y.a.getObject(me,[]);e.start().then(()=>{let a=e.getLabelKeys();if(a.length>1e4){const e=`Too many labels found (showing only 10000 of ${a.length})`;a=a.slice(0,1e4),this.setState({error:e})}this.fetchValues("__name__","{}");const r=a.map((e,a,r)=>({name:e,selected:t.includes(e),loading:!1}));this.setState({labels:r},()=>{this.state.labels.forEach(e=>{e.selected&&this.fetchValues(e.name,"{}")})})})}}doFacettingForLabel(e){const t=this.state.labels.find(t=>t.name===e);if(!t)return;const a=this.state.labels.filter(e=>e.selected).map(e=>e.name);Y.a.setObject(me,a),t.selected?t.values||this.fetchValues(e,ge(this.state.labels)):this.doFacetting()}async fetchValues(e,t){const{languageProvider:a}=this.props;this.updateLabelState(e,{loading:!0},"Fetching values for "+e);try{let s=await a.getLabelValues(e);if(t!==ge(this.state.labels))return void this.updateLabelState(e,{loading:!1});if(s.length>5e4){const t=`Too many values for ${e} (showing only 50000 of ${s.length})`;s=s.slice(0,5e4),this.setState({error:t})}const n=[],{metricsMetadata:i}=a;for(const t of s){const a={name:t};if("__name__"===e&&i){var r;const e=null===(r=i[t])||void 0===r?void 0:r[0];e&&(a.details=`(${e.type}) ${e.help}`)}n.push(a)}this.updateLabelState(e,{values:n,loading:!1})}catch(e){console.error(e)}}async fetchSeries(e,t){const{languageProvider:a}=this.props;t&&this.updateLabelState(t,{loading:!0},"Facetting labels for "+e);try{const r=await a.fetchSeriesLabels(e,!0);if(e!==ge(this.state.labels))return void(t&&this.updateLabelState(t,{loading:!1}));if(0===Object.keys(r).length)return console.error("No results for label combination, but should not occur."),void this.setState({error:"Facetting failed for "+e});const s=function(e,t,a){return e.map(e=>{const r=t[e.name];if(r){let t;if(e.name===a&&e.values)t=e.values;else{var s;const a=new Set((null===(s=e.values)||void 0===s?void 0:s.filter(e=>e.selected).map(e=>e.name))||[]);t=r.map(e=>({name:e,selected:a.has(e)}))}return pe({},e,{loading:!1,values:t,hidden:!r,facets:t.length})}return pe({},e,{loading:!1,hidden:!r,values:void 0,facets:0})})}(this.state.labels,r,t);this.setState({labels:s,error:""}),t&&this.updateLabelState(t,{loading:!1})}catch(e){console.error(e)}}async validateSelector(e){const{languageProvider:t}=this.props;this.setState({validationStatus:"Validating selector "+e,error:""});const a=await t.fetchSeries(e);this.setState({validationStatus:`Selector is valid (${a.length} series found)`})}render(){var e,t;const{theme:a}=this.props,{labels:r,labelSearchTerm:s,metricSearchTerm:n,status:i,error:l,validationStatus:o,valueSearchTerm:c}=this.state,u=be(a);if(0===r.length)return Object(ae.jsx)("div",{className:u.wrapper,children:le||(le=Object(ae.jsx)(W.LoadingPlaceholder,{text:"Loading labels..."}))});let d=r.find(e=>"__name__"===e.name);var h;d&&n&&(d=pe({},d,{values:null===(h=d.values)||void 0===h?void 0:h.filter(e=>e.selected||e.name.includes(n))}));let p=r.filter(e=>!e.hidden&&"__name__"!==e.name);s&&(p=p.filter(e=>e.selected||e.name.includes(s)));let m=p.filter(e=>e.selected&&e.values);c&&(m=m.map(e=>{var t;return pe({},e,{values:null===(t=e.values)||void 0===t?void 0:t.filter(e=>e.selected||e.name.includes(c))})}));const g=ge(this.state.labels),b="{}"===g,f=(null===(e=d)||void 0===e||null===(t=e.values)||void 0===t?void 0:t.length)||0;return Object(ae.jsxs)("div",{className:u.wrapper,children:[Object(ae.jsxs)(W.HorizontalGroup,{align:"flex-start",spacing:"lg",children:[Object(ae.jsx)("div",{children:Object(ae.jsxs)("div",{className:u.section,children:[oe||(oe=Object(ae.jsx)(W.Label,{description:"Once a metric is selected only possible labels are shown.",children:"1. Select a metric"})),Object(ae.jsx)("div",{children:Object(ae.jsx)(W.Input,{onChange:this.onChangeMetricSearch,"aria-label":"Filter expression for metric",value:n})}),Object(ae.jsx)("div",{role:"list",className:u.valueListWrapper,children:Object(ae.jsx)(Z.a,{height:Math.min(450,25*f),itemCount:f,itemSize:25,itemKey:e=>d.values[e].name,width:300,className:u.valueList,children:({index:e,style:t})=>{var a,r;const s=null===(a=d)||void 0===a||null===(r=a.values)||void 0===r?void 0:r[e];return s?Object(ae.jsx)("div",{style:t,children:Object(ae.jsx)(ne,{name:d.name,value:null==s?void 0:s.name,title:s.details,active:null==s?void 0:s.selected,onClick:this.onClickMetric,searchTerm:n})}):null}})})]})}),Object(ae.jsxs)("div",{children:[Object(ae.jsxs)("div",{className:u.section,children:[ce||(ce=Object(ae.jsx)(W.Label,{description:"Once label values are selected, only possible label combinations are shown.",children:"2. Select labels to search in"})),Object(ae.jsx)("div",{children:Object(ae.jsx)(W.Input,{onChange:this.onChangeLabelSearch,"aria-label":"Filter expression for label",value:s})}),Object(ae.jsx)("div",{className:u.list,style:{height:120},children:p.map(e=>Object(ae.jsx)(ne,{name:e.name,loading:e.loading,active:e.selected,hidden:e.hidden,facets:e.facets,onClick:this.onClickLabel,searchTerm:s},e.name))})]}),Object(ae.jsxs)("div",{className:u.section,children:[ue||(ue=Object(ae.jsx)(W.Label,{description:"Use the search field to find values across selected labels.",children:"3. Select (multiple) values for your labels"})),Object(ae.jsx)("div",{children:Object(ae.jsx)(W.Input,{onChange:this.onChangeValueSearch,"aria-label":"Filter expression for label values",value:c})}),Object(ae.jsx)("div",{className:u.valueListArea,ref:this.valueListsRef,children:m.map(e=>{var t,a,r;return Object(ae.jsxs)("div",{role:"list","aria-label":"Values for "+e.name,className:u.valueListWrapper,children:[Object(ae.jsx)("div",{className:u.valueTitle,children:Object(ae.jsx)(ne,{name:e.name,loading:e.loading,active:e.selected,hidden:e.hidden,facets:e.facets||(null===(t=e.values)||void 0===t?void 0:t.length),onClick:this.onClickLabel})}),Object(ae.jsx)(Z.a,{height:Math.min(200,25*((null===(a=e.values)||void 0===a?void 0:a.length)||0)),itemCount:(null===(r=e.values)||void 0===r?void 0:r.length)||0,itemSize:25,itemKey:t=>e.values[t].name,width:200,className:u.valueList,children:({index:t,style:a})=>{var r;const s=null===(r=e.values)||void 0===r?void 0:r[t];return s?Object(ae.jsx)("div",{style:a,children:Object(ae.jsx)(ne,{name:e.name,value:null==s?void 0:s.name,active:null==s?void 0:s.selected,onClick:this.onClickValue,searchTerm:c})}):null}})]},e.name)})})]})]})]}),Object(ae.jsxs)("div",{className:u.section,children:[de||(de=Object(ae.jsx)(W.Label,{children:"4. Resulting selector"})),Object(ae.jsx)("div",{"aria-label":"selector",className:u.selector,children:g}),o&&Object(ae.jsx)("div",{className:u.validationStatus,children:o}),Object(ae.jsxs)(W.HorizontalGroup,{children:[Object(ae.jsx)(W.Button,{"aria-label":"Use selector for query button",disabled:b,onClick:this.onClickRunQuery,children:"Use query"}),Object(ae.jsx)(W.Button,{"aria-label":"Use selector as metrics button",variant:"secondary",disabled:b,onClick:this.onClickRunRateQuery,children:"Use as rate query"}),Object(ae.jsx)(W.Button,{"aria-label":"Validate submit button",variant:"secondary",disabled:b,onClick:this.onClickValidate,children:"Validate selector"}),Object(ae.jsx)(W.Button,{"aria-label":"Selector clear button",variant:"secondary",onClick:this.onClickClear,children:"Clear"}),Object(ae.jsx)("div",{className:Object(J.cx)(u.status,(i||l)&&u.statusShowing),children:Object(ae.jsx)("span",{className:l?u.error:"",children:l||i})})]})]})]})}}const ve=Object(W.withTheme)(fe);function je(){return(je=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function ye(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function xe(e,{typeaheadContext:t,typeaheadText:a}){switch(t){case"context-labels":{const t=W.DOMUtil.getNextCharacter();t&&"}"!==t&&","!==t||(e+="=");break}case"context-label-values":a.match(/^(!?=~?"|")/)||(e='"'+e),'"'!==W.DOMUtil.getNextCharacter()&&(e+='"')}return e}class Oe extends G.a.PureComponent{constructor(e,t){super(e,t),ye(this,"plugins",void 0),ye(this,"refreshHint",()=>{const{datasource:e,query:t,data:a}=this.props,s=e.getInitHints(),n=s.length>0?s[0]:null;if(!a||0===a.series.length)return void this.setState({hint:n});const i=Object(r.isDataFrame)(a.series[0])?a.series.map(r.toLegacyResponseData):a.series,l=e.getQueryHints(t,i);let o=l.length>0?l[0]:null;this.setState({hint:null!=o?o:n})}),ye(this,"refreshMetrics",async()=>{const{datasource:{languageProvider:e}}=this.props;this.languageProviderInitializationPromise=(e=>{let t=!1;return{promise:new Promise((a,r)=>{e.then(e=>t?r({isCanceled:!0}):a(e)),e.catch(e=>r(t?{isCanceled:!0}:e))}),cancel(){t=!0}}})(e.start());try{const e=await this.languageProviderInitializationPromise.promise;await Promise.all(e),this.onUpdateLanguage()}catch(e){if(!e.isCanceled)throw e}}),ye(this,"onChangeLabelBrowser",e=>{this.onChangeQuery(e,!0),this.setState({labelBrowserVisible:!1})}),ye(this,"onChangeQuery",(e,t)=>{const{query:a,onChange:r,onRunQuery:s}=this.props;if(r){r(je({},a,{expr:e})),t&&s&&s()}}),ye(this,"onClickChooserButton",()=>{this.setState(e=>({labelBrowserVisible:!e.labelBrowserVisible}))}),ye(this,"onClickHintFix",()=>{const{datasource:e,query:t,onChange:a,onRunQuery:r}=this.props,{hint:s}=this.state;a(e.modifyQuery(t,s.fix.action)),r()}),ye(this,"onUpdateLanguage",()=>{const{datasource:{languageProvider:e}}=this.props,{metrics:t}=e;t&&this.setState({syntaxLoaded:!0})}),ye(this,"onTypeahead",async e=>{const{datasource:{languageProvider:t}}=this.props;if(!t)return{suggestions:[]};const{history:a}=this.props,{prefix:r,text:s,value:n,wrapperClasses:i,labelKey:l}=e;return await t.provideCompletionItems({text:s,value:n,prefix:r,wrapperClasses:i,labelKey:l},{history:a})}),this.plugins=[Object(W.BracesPlugin)(),Object(W.SlatePrism)({onlyIn:e=>"code_block"===e.type,getSyntax:e=>"promql"},je({},K.languages,{promql:this.props.datasource.languageProvider.syntax}))],this.state={labelBrowserVisible:!1,syntaxLoaded:!1,hint:null}}componentDidMount(){this.props.datasource.languageProvider&&this.refreshMetrics(),this.refreshHint()}componentWillUnmount(){this.languageProviderInitializationPromise&&this.languageProviderInitializationPromise.cancel()}componentDidUpdate(e){const{data:t,datasource:{languageProvider:a},range:r}=this.props;a!==e.datasource.languageProvider&&this.setState({syntaxLoaded:!1});const s=this.rangeChangedToRefresh(r,e.range);(a!==e.datasource.languageProvider||s)&&this.refreshMetrics(),t&&e.data&&e.data.series!==t.series&&this.refreshHint()}rangeChangedToRefresh(e,t){if(e&&t){const a=Object(S.i)(e.from.valueOf())===Object(S.i)(t.from.valueOf()),r=Object(S.i)(e.to.valueOf())===Object(S.i)(t.to.valueOf());return!(a&&r)}return!1}render(){const{datasource:e,datasource:{languageProvider:t},query:a,ExtraFieldElement:r,placeholder:s="Enter a PromQL query (run with Shift+Enter)"}=this.props,{labelBrowserVisible:n,syntaxLoaded:i,hint:l}=this.state,o=t?t.cleanText:void 0,c=t.metrics.length>0,u=function(e,t,a){return e?"(Disabled)":t?a?"Metrics browser":"(No metrics found)":"Loading metrics..."}(e.lookupsDisabled,i,c),d=!(i&&c);return Object(ae.jsxs)(ae.Fragment,{children:[Object(ae.jsxs)("div",{className:"gf-form-inline gf-form-inline--xs-view-flex-column flex-grow-1","data-testid":this.props["data-testid"],children:[Object(ae.jsxs)("button",{className:"gf-form-label query-keyword pointer",onClick:this.onClickChooserButton,disabled:d,children:[u,Object(ae.jsx)(W.Icon,{name:n?"angle-down":"angle-right"})]}),Object(ae.jsx)("div",{className:"gf-form gf-form--grow flex-shrink-1 min-width-15",children:Object(ae.jsx)(W.QueryField,{additionalPlugins:this.plugins,cleanText:o,query:a.expr,onTypeahead:this.onTypeahead,onWillApplySuggestion:xe,onBlur:this.props.onBlur,onChange:this.onChangeQuery,onRunQuery:this.props.onRunQuery,placeholder:s,portalOrigin:"prometheus",syntaxLoaded:i})})]}),n&&Object(ae.jsx)("div",{className:"gf-form",children:Object(ae.jsx)(ve,{languageProvider:t,onChange:this.onChangeLabelBrowser})}),r,l?Object(ae.jsx)("div",{className:"query-row-break",children:Object(ae.jsxs)("div",{className:"prom-query-field-info text-warning",children:[l.label," ",l.fix?Object(ae.jsx)("a",{className:"text-link muted",onClick:this.onClickHintFix,children:l.fix.label}):null]})}):null]})}}var Se=Oe;const Ie=({panelData:e,query:t,datasource:a})=>{const[s,n]=Object(H.useState)("");return Object(H.useEffect)(()=>{if(e){n((()=>{if(!e.request)return"";const{request:{range:r,interval:s}}=e,n=a.getPrometheusTime(r.from,!1),i=a.getPrometheusTime(r.to,!0),l=Math.ceil(i-n),c=r.to.utc().format("YYYY-MM-DD HH:mm"),u={interval:s},d=a.createQuery(t,u,n,i),h={"g0.expr":d.expr,"g0.range_input":l+"s","g0.end_input":c,"g0.step_input":d.step,"g0.tab":0},p=Object(o.map)(h,(e,t)=>t+"="+encodeURIComponent(e)).join("&");return`${a.directUrl}/graph?${p}`})())}},[a,e,t]),Object(ae.jsx)("a",{href:r.textUtil.sanitizeUrl(s),target:"_blank",rel:"noopener noreferrer",children:"Prometheus"})};var we,Ce,Te,_e,Ee=Object(H.memo)(Ie);function qe({datasource:e,onChange:t,isEnabled:a,refId:r}){const[s,n]=Object(H.useState)(null),i=Object(W.useStyles2)(Ne);Object(H.useEffect)(()=>{const t=e.exemplarErrors.pipe(Object(v.a)(e=>r===e.refId)).subscribe(e=>{n(e.error)});return()=>{t.unsubscribe()}},[e,r]);const l=Object(J.cx)({[i.activeIcon]:a},i.eyeIcon);return Object(ae.jsx)(W.InlineLabel,{width:"auto",children:Object(ae.jsx)(W.Tooltip,{content:null!=s?s:"",children:Object(ae.jsxs)("div",{className:i.iconWrapper,children:["Exemplars",Object(ae.jsx)(W.IconButton,{name:"eye",tooltip:a?"Disable query with exemplars":"Enable query with exemplars",disabled:!!s,className:l,onClick:()=>{t(!a)}})]})})})}function Ne(e){return{eyeIcon:J.css`
      margin-left: ${e.spacing(2)};
    `,activeIcon:J.css`
      color: ${e.colors.primary.main};
    `,iconWrapper:J.css`
      display: flex;
      align-items: center;
    `}}function Pe(){return(Pe=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function De(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}const{Switch:Le}=W.LegacyForms,Fe=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"},{label:"Heatmap",value:"heatmap"}],ke=Object(o.map)([1,2,3,4,5,10],e=>({value:e,label:"1/"+e}));class Re extends H.PureComponent{constructor(e){super(e),De(this,"query",void 0),De(this,"onFieldChange",(e,t)=>{this.query.expr=e.expr}),De(this,"onFormatChange",e=>{this.query.format=e.value,this.setState({formatOption:e},this.onRunQuery)}),De(this,"onInstantChange",e=>{const t=e.target.checked;this.query.instant=t,this.setState({instant:t},this.onRunQuery)}),De(this,"onIntervalChange",e=>{const t=e.currentTarget.value;this.query.interval=t,this.setState({interval:t})}),De(this,"onIntervalFactorChange",e=>{this.query.intervalFactor=e.value,this.setState({intervalFactorOption:e},this.onRunQuery)}),De(this,"onLegendChange",e=>{const t=e.currentTarget.value;this.query.legendFormat=t,this.setState({legendFormat:t})}),De(this,"onExemplarChange",e=>{this.query.exemplar=e,this.setState({exemplar:e},this.onRunQuery)}),De(this,"onRunQuery",()=>{const{query:e}=this,{hide:t}=this.props.query;this.props.onChange(Pe({},e,{hide:t})),this.props.onRunQuery()});const t=Object.assign({},{expr:"",legendFormat:"",interval:"",exemplar:!0},e.query);this.query=t,this.state={interval:t.interval,legendFormat:t.legendFormat,formatOption:Fe.find(e=>e.value===t.format)||Fe[0],intervalFactorOption:ke.find(e=>e.value===t.intervalFactor)||ke[0],instant:Boolean(t.instant),exemplar:Boolean(t.exemplar)}}render(){const{datasource:e,query:t,range:a,data:r}=this.props,{formatOption:s,instant:n,interval:i,intervalFactorOption:l,legendFormat:o,exemplar:c}=this.state;return Object(ae.jsx)(Se,{datasource:e,query:t,range:a,onRunQuery:this.onRunQuery,onChange:this.onFieldChange,history:[],data:r,"data-testid":Ae.editor,ExtraFieldElement:Object(ae.jsxs)("div",{className:"gf-form-inline",children:[Object(ae.jsxs)("div",{className:"gf-form",children:[we||(we=Object(ae.jsx)(W.InlineFormLabel,{width:7,tooltip:"Controls the name of the time series, using name or pattern. For example {{hostname}} will be replaced with label value for the label hostname.",children:"Legend"})),Object(ae.jsx)("input",{type:"text",className:"gf-form-input",placeholder:"legend format",value:o,onChange:this.onLegendChange,onBlur:this.onRunQuery})]}),Object(ae.jsxs)("div",{className:"gf-form",children:[Ce||(Ce=Object(ae.jsx)(W.InlineFormLabel,{width:7,tooltip:Object(ae.jsxs)(ae.Fragment,{children:["An additional lower limit for the step parameter of the Prometheus query and for the"," ",Object(ae.jsx)("code",{children:"$__interval"})," and ",Object(ae.jsx)("code",{children:"$__rate_interval"}),' variables. The limit is absolute and not modified by the "Resolution" setting.']}),children:"Min step"})),Object(ae.jsx)("input",{type:"text",className:"gf-form-input width-8",placeholder:i,onChange:this.onIntervalChange,onBlur:this.onRunQuery,value:i})]}),Object(ae.jsxs)("div",{className:"gf-form",children:[Te||(Te=Object(ae.jsx)("div",{className:"gf-form-label",children:"Resolution"})),Object(ae.jsx)(W.Select,{menuShouldPortal:!0,isSearchable:!1,options:ke,onChange:this.onIntervalFactorChange,value:l})]}),Object(ae.jsxs)("div",{className:"gf-form",children:[_e||(_e=Object(ae.jsx)("div",{className:"gf-form-label width-7",children:"Format"})),Object(ae.jsx)(W.Select,{menuShouldPortal:!0,width:16,isSearchable:!1,options:Fe,onChange:this.onFormatChange,value:s}),Object(ae.jsx)(Le,{label:"Instant",checked:n,onChange:this.onInstantChange}),Object(ae.jsx)(W.InlineFormLabel,{width:10,tooltip:"Link to Graph in Prometheus",children:Object(ae.jsx)(Ee,{datasource:e,query:this.query,panelData:r})})]}),Object(ae.jsx)(qe,{refId:t.refId,isEnabled:c,onChange:this.onExemplarChange,datasource:e})]})})}}const Ae={editor:"prom-editor"};function Xe(e){const{datasource:t,query:a,range:r,data:s,onChange:n,onRunQuery:i}=e;return Object(ae.jsx)(Se,{datasource:t,query:a,onRunQuery:i,onChange:n,history:[],range:r,data:s,placeholder:"Enter a PromQL query","data-testid":Qe.editor})}const Qe={editor:"prom-editor-cloud-alerting"};function Me(){return(Me=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function $e(e){const{app:t}=e;switch(t){case r.CoreApp.CloudAlerting:return Object(ae.jsx)(Xe,Me({},e));default:return Object(ae.jsx)(Re,Me({},e))}}var Ve,Ue=Object(H.memo)($e);const ze=[{title:"Request Rate",expression:"rate(http_request_total[5m])",label:"Given an HTTP request counter, this query calculates the per-second average request rate over the last 5 minutes."},{title:"95th Percentile of Request Latencies",expression:"histogram_quantile(0.95, sum(rate(prometheus_http_request_duration_seconds_bucket[5m])) by (le))",label:"Calculates the 95th percentile of HTTP request rate over 5 minute windows."},{title:"Alerts Firing",expression:'sort_desc(sum(sum_over_time(ALERTS{alertstate="firing"}[24h])) by (alertname))',label:"Sums up the alerts that have been firing over the last 24 hours."},{title:"Step",label:"Defines the graph resolution using a duration format (15s, 1m, 3h, ...). Small steps create high-resolution graphs but can be slow over larger time ranges. Using a longer step lowers the resolution and smooths the graph by producing fewer datapoints. If no step is given the resolution is calculated automatically."}];var Be,He,Ge=e=>Object(ae.jsxs)("div",{children:[Ve||(Ve=Object(ae.jsx)("h2",{children:"PromQL Cheat Sheet"})),ze.map((t,a)=>Object(ae.jsxs)("div",{className:"cheat-sheet-item",children:[Object(ae.jsx)("div",{className:"cheat-sheet-item__title",children:t.title}),t.expression?Object(ae.jsx)("div",{className:"cheat-sheet-item__example",onClick:a=>e.onClickExample({refId:"A",expr:t.expression}),children:Object(ae.jsx)("code",{children:t.expression})}):null,Object(ae.jsx)("div",{className:"cheat-sheet-item__label",children:t.label})]},a))]});function We(){return(We=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const Ke=Object(H.memo)(({queryType:e,stepValue:t,query:a,onChange:r,onStepChange:s,onQueryTypeChange:n,onKeyDownFunc:i,datasource:l})=>Object(ae.jsxs)("div",{"aria-label":"Prometheus extra field",className:"gf-form-inline",children:[Object(ae.jsxs)("div",{"data-testid":"queryTypeField",className:Object(J.cx)("gf-form explore-input-margin",J.css`
              flex-wrap: nowrap;
            `),"aria-label":"Query type field",children:[Be||(Be=Object(ae.jsx)(W.InlineFormLabel,{width:"auto",children:"Query type"})),Object(ae.jsx)(W.RadioButtonGroup,{options:[{value:"range",label:"Range",description:"Run query over a range of time."},{value:"instant",label:"Instant",description:'Run query against a single point in time. For this query, the "To" time is used.'},{value:"both",label:"Both",description:"Run an Instant query and a Range query."}],value:e,onChange:n})]}),Object(ae.jsxs)("div",{"data-testid":"stepField",className:Object(J.cx)("gf-form",J.css`
              flex-wrap: nowrap;
            `),"aria-label":"Step field",children:[He||(He=Object(ae.jsx)(W.InlineFormLabel,{width:5,tooltip:"Time units can be used here, for example: 5s, 1m, 3h, 1d, 1y (Default if no unit is specified: s)",children:"Step"})),Object(ae.jsx)("input",{type:"text",className:"gf-form-input width-4",placeholder:"auto",onChange:s,onKeyDown:i,value:t})]}),Object(ae.jsx)(qe,{refId:a.refId,isEnabled:Boolean(a.exemplar),onChange:e=>r(We({},a,{exemplar:e})),datasource:l})]}));function Je(){return(Je=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const Ye=e=>{const{range:t,query:a,data:r,datasource:s,history:n,onChange:i,onRunQuery:l}=e;return Object(H.useEffect)(()=>{void 0===a.exemplar&&i(Je({},a,{exemplar:!0}))},[i,a]),Object(ae.jsx)(Se,{datasource:s,query:a,range:t,onRunQuery:l,onChange:i,onBlur:()=>{},history:n,data:r,ExtraFieldElement:Object(ae.jsx)(Ke,{queryType:a.range===a.instant?"both":a.instant?"instant":"range",stepValue:a.interval||"",onQueryTypeChange:function(t){const{query:a,onChange:r}=e;let s;s=Je({},a,"instant"===t?{instant:!0,range:!1}:"range"===t?{instant:!1,range:!0}:{instant:!0,range:!0}),r(s)},onStepChange:function(t){t.currentTarget.value!==a.interval&&function(t){const{query:a,onChange:r}=e;r(Je({},a,{interval:t}))}(t.currentTarget.value)},onKeyDownFunc:function(e){"Enter"===e.key&&(e.shiftKey||e.ctrlKey)&&l()},query:a,onChange:i,datasource:s})})};var Ze=Object(H.memo)(Ye),et=a("ZFWI");let tt;!function(e){e.Public="AzureCloud",e.China="AzureChinaCloud",e.USGovernment="AzureUSGovernment",e.Germany="AzureGermanCloud",e.None=""}(tt||(tt={}));const at=[{value:tt.Public,label:"Azure"},{value:tt.China,label:"Azure China"},{value:tt.USGovernment,label:"Azure US Government"},{value:tt.Germany,label:"Azure Germany"}];function rt(){return(rt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const st=Symbol("Concealed client secret");function nt(){return s.config.azure.cloud||tt.Public}function it(e){if(e.secureJsonFields.azureClientSecret)return st;{var t;const a=null===(t=e.secureJsonData)||void 0===t?void 0:t.azureClientSecret;return"string"==typeof a&&a.length>0?a:void 0}}var lt,ot,ct,ut,dt,ht,pt,mt=a("aPt1"),gt=a("f9li"),bt=a("ZCGc");function ft(){return(ft=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const vt=[{value:"msi",label:"Managed Identity"},{value:"clientsecret",label:"App Registration"}],jt=e=>{const{credentials:t,azureCloudOptions:a,onCredentialsChange:r,getSubscriptions:s}=e,n=function(e){switch(e.authType){case"msi":return!0;case"clientsecret":return!!(e.azureCloud&&e.tenantId&&e.clientId&&e.clientSecret)}}(t),[i,l]=Object(H.useState)([]),[o,c]=Object(H.useReducer)(e=>e+1,0);Object(H.useEffect)(()=>{if(!s||!n)return void u([]);let e=!1;return s().then(t=>{e||u(t,o)}),()=>{e=!0}},[o]);const u=(e,a=!1)=>{if(l(e),s)if(a&&!t.defaultSubscriptionId&&e.length>0)d(e[0]);else if(t.defaultSubscriptionId){e.find(e=>e.value===t.defaultSubscriptionId)||d(void 0)}},d=e=>{if(r){const a=ft({},t,{defaultSubscriptionId:null==e?void 0:e.value});r(a)}};return Object(ae.jsxs)("div",{className:"gf-form-group",children:[e.managedIdentityEnabled&&Object(ae.jsx)("div",{className:"gf-form-inline",children:Object(ae.jsxs)("div",{className:"gf-form",children:[lt||(lt=Object(ae.jsx)(mt.gc,{className:"width-12",tooltip:"Choose the type of authentication to Azure services",children:"Authentication"})),Object(ae.jsx)(gt.b,{menuShouldPortal:!0,className:"width-15",value:vt.find(e=>e.value===t.authType),options:vt,onChange:e=>{if(r){l([]);const a=ft({},t,{authType:e.value||"msi",defaultSubscriptionId:void 0});r(a)}}})]})}),"clientsecret"===t.authType&&Object(ae.jsxs)(ae.Fragment,{children:[a&&Object(ae.jsx)("div",{className:"gf-form-inline",children:Object(ae.jsxs)("div",{className:"gf-form",children:[ot||(ot=Object(ae.jsx)(mt.gc,{className:"width-12",tooltip:"Choose an Azure Cloud",children:"Azure Cloud"})),Object(ae.jsx)(gt.b,{menuShouldPortal:!0,className:"width-15",value:a.find(e=>e.value===t.azureCloud),options:a,onChange:e=>{if(r&&"clientsecret"===t.authType){l([]);const a=ft({},t,{azureCloud:e.value,defaultSubscriptionId:void 0});r(a)}}})]})}),Object(ae.jsx)("div",{className:"gf-form-inline",children:Object(ae.jsxs)("div",{className:"gf-form",children:[ct||(ct=Object(ae.jsx)(mt.gc,{className:"width-12",children:"Directory (tenant) ID"})),Object(ae.jsx)("div",{className:"width-15",children:Object(ae.jsx)(bt.a,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:t.tenantId||"",onChange:e=>{if(r&&"clientsecret"===t.authType){l([]);const a=ft({},t,{tenantId:e.target.value,defaultSubscriptionId:void 0});r(a)}}})})]})}),Object(ae.jsx)("div",{className:"gf-form-inline",children:Object(ae.jsxs)("div",{className:"gf-form",children:[ut||(ut=Object(ae.jsx)(mt.gc,{className:"width-12",children:"Application (client) ID"})),Object(ae.jsx)("div",{className:"width-15",children:Object(ae.jsx)(bt.a,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:t.clientId||"",onChange:e=>{if(r&&"clientsecret"===t.authType){l([]);const a=ft({},t,{clientId:e.target.value,defaultSubscriptionId:void 0});r(a)}}})})]})}),"symbol"==typeof t.clientSecret?Object(ae.jsxs)("div",{className:"gf-form-inline",children:[dt||(dt=Object(ae.jsxs)("div",{className:"gf-form",children:[Object(ae.jsx)(mt.gc,{className:"width-12",children:"Client Secret"}),Object(ae.jsx)(bt.a,{className:"width-25",placeholder:"configured",disabled:!0})]})),Object(ae.jsx)("div",{className:"gf-form",children:Object(ae.jsx)("div",{className:"max-width-30 gf-form-inline",children:Object(ae.jsx)(mt.s,{variant:"secondary",type:"button",onClick:()=>{if(r&&"clientsecret"===t.authType){l([]);const e=ft({},t,{clientSecret:"",defaultSubscriptionId:void 0});r(e)}},children:"reset"})})})]}):Object(ae.jsx)("div",{className:"gf-form-inline",children:Object(ae.jsxs)("div",{className:"gf-form",children:[ht||(ht=Object(ae.jsx)(mt.gc,{className:"width-12",children:"Client Secret"})),Object(ae.jsx)("div",{className:"width-15",children:Object(ae.jsx)(bt.a,{className:"width-30",placeholder:"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX",value:t.clientSecret||"",onChange:e=>{if(r&&"clientsecret"===t.authType){l([]);const a=ft({},t,{clientSecret:e.target.value,defaultSubscriptionId:void 0});r(a)}}})})]})})]}),s&&Object(ae.jsxs)(ae.Fragment,{children:[Object(ae.jsx)("div",{className:"gf-form-inline",children:Object(ae.jsxs)("div",{className:"gf-form",children:[pt||(pt=Object(ae.jsx)(mt.gc,{className:"width-12",children:"Default Subscription"})),Object(ae.jsx)("div",{className:"width-25",children:Object(ae.jsx)(gt.b,{menuShouldPortal:!0,value:t.defaultSubscriptionId?i.find(e=>e.value===t.defaultSubscriptionId):void 0,options:i,onChange:d})})]})}),Object(ae.jsx)("div",{className:"gf-form-inline",children:Object(ae.jsx)("div",{className:"gf-form",children:Object(ae.jsx)("div",{className:"max-width-30 gf-form-inline",children:Object(ae.jsx)(mt.s,{variant:"secondary",size:"sm",type:"button",onClick:c,disabled:!n,children:"Load Subscriptions"})})})})]})]})};var yt,xt,Ot;function St(){return(St=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const It=e=>{const{dataSourceConfig:t,onChange:a}=e,r=Object(H.useMemo)(()=>function(e){const t=e.jsonData.azureCredentials;if(!t)return{authType:s.config.azure.managedIdentityEnabled?"msi":"clientsecret",azureCloud:nt()};switch(t.authType){case"msi":return s.config.azure.managedIdentityEnabled?{authType:"msi"}:{authType:"clientsecret",azureCloud:nt()};case"clientsecret":return{authType:"clientsecret",azureCloud:t.azureCloud||nt(),tenantId:t.tenantId,clientId:t.clientId,clientSecret:it(e)}}}(t),[t]);return Object(ae.jsxs)(ae.Fragment,{children:[yt||(yt=Object(ae.jsx)("h6",{children:"Azure Authentication"})),Object(ae.jsx)(jt,{managedIdentityEnabled:s.config.azure.managedIdentityEnabled,credentials:r,azureCloudOptions:at,onCredentialsChange:e=>{a(function(e,t){switch(t.authType){case"msi":if(!s.config.azure.managedIdentityEnabled)throw new Error("Managed Identity authentication is not enabled in Grafana config.");return e=rt({},e,{jsonData:rt({},e.jsonData,{azureCredentials:{authType:"msi"}})});case"clientsecret":return e=rt({},e,{jsonData:rt({},e.jsonData,{azureCredentials:{authType:"clientsecret",azureCloud:t.azureCloud||nt(),tenantId:t.tenantId,clientId:t.clientId}}),secureJsonData:rt({},e.secureJsonData,{azureClientSecret:"string"==typeof t.clientSecret&&t.clientSecret.length>0?t.clientSecret:void 0}),secureJsonFields:rt({},e.secureJsonFields,{azureClientSecret:"symbol"==typeof t.clientSecret})})}}(t,e))}}),xt||(xt=Object(ae.jsx)("h6",{children:"Azure Configuration"})),Object(ae.jsx)("div",{className:"gf-form-group",children:Object(ae.jsx)("div",{className:"gf-form-inline",children:Object(ae.jsxs)("div",{className:"gf-form",children:[Ot||(Ot=Object(ae.jsx)(W.InlineFormLabel,{className:"width-12",children:"AAD resource ID"})),Object(ae.jsx)("div",{className:"width-15",children:Object(ae.jsx)(W.Input,{className:"width-30",value:t.jsonData.azureEndpointResourceId||"",onChange:e=>a(St({},t,{jsonData:St({},t.jsonData,{azureEndpointResourceId:e.currentTarget.value})}))})})]})})})]})};var wt,Ct,Tt,_t=a("Csm0");function Et(){return(Et=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function qt({value:e,onChange:t,onDelete:a}){const[r,n]=Object(H.useState)(Boolean(e.datasourceUid));return Object(ae.jsxs)("div",{className:"gf-form-group",children:[Object(ae.jsx)(W.InlineField,{label:"Internal link",labelWidth:24,children:Object(ae.jsxs)(ae.Fragment,{children:[Object(ae.jsx)(W.InlineSwitch,{value:r,"aria-label":_t.a.components.DataSource.Prometheus.configPage.internalLinkSwitch,onChange:e=>n(e.currentTarget.checked)}),Object(ae.jsx)(W.Button,{variant:"destructive",title:"Remove link",icon:"times",onClick:e=>{e.preventDefault(),a()},className:J.css`
              margin-left: 8px;
            `})]})}),r?Object(ae.jsx)(W.InlineField,{label:"Data source",labelWidth:24,tooltip:"The data source the exemplar is going to navigate to.",children:Object(ae.jsx)(s.DataSourcePicker,{tracing:!0,current:e.datasourceUid,noDefault:!0,width:40,onChange:a=>t({datasourceUid:a.uid,name:e.name,url:void 0})})}):Object(ae.jsx)(W.InlineField,{label:"URL",labelWidth:24,tooltip:"The URL of the trace backend the user would go to see its trace.",children:Object(ae.jsx)(W.Input,{placeholder:"https://example.com/${__value.raw}",spellCheck:!1,width:40,value:e.url,onChange:a=>t({datasourceUid:void 0,name:e.name,url:a.currentTarget.value})})}),Object(ae.jsx)(W.InlineField,{label:"Label name",labelWidth:24,tooltip:"The name of the field in the labels object that should be used to get the traceID.",children:Object(ae.jsx)(W.Input,{placeholder:"traceID",spellCheck:!1,width:40,value:e.name,onChange:a=>t(Et({},e,{name:a.currentTarget.value}))})})]})}function Nt({options:e,onChange:t}){return Object(ae.jsxs)(ae.Fragment,{children:[wt||(wt=Object(ae.jsx)("h3",{className:"page-heading",children:"Exemplars"})),e&&e.map((a,r)=>Object(ae.jsx)(qt,{value:a,onChange:a=>{const s=[...e];s.splice(r,1,a),t(s)},onDelete:()=>{const a=[...e];a.splice(r,1),t(a)}},r)),Object(ae.jsx)(W.Button,{variant:"secondary","aria-label":_t.a.components.DataSource.Prometheus.configPage.exemplarsAddButton,className:J.css`
          margin-bottom: 10px;
        `,icon:"plus",onClick:a=>{a.preventDefault();const r=[...e||[],{name:"traceID"}];t(r)},children:"Add"})]})}function Pt(){return(Pt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}const{Select:Dt,Input:Lt,FormField:Ft,Switch:kt}=W.LegacyForms,Rt=[{value:"POST",label:"POST"},{value:"GET",label:"GET"}],At=e=>{var t;const{options:a,onOptionsChange:s}=e;return a.jsonData.httpMethod||(a.jsonData.httpMethod="POST"),Object(ae.jsxs)(ae.Fragment,{children:[Object(ae.jsxs)("div",{className:"gf-form-group",children:[Object(ae.jsx)("div",{className:"gf-form-inline",children:Object(ae.jsx)("div",{className:"gf-form",children:Object(ae.jsx)(Ft,{label:"Scrape interval",labelWidth:13,inputEl:Object(ae.jsx)(Lt,{className:"width-6",value:a.jsonData.timeInterval,spellCheck:!1,placeholder:"15s",onChange:Mt("timeInterval",a,s),validationEvents:Xt}),tooltip:"Set this to the typical scrape and evaluation interval configured in Prometheus. Defaults to 15s."})})}),Object(ae.jsx)("div",{className:"gf-form-inline",children:Object(ae.jsx)("div",{className:"gf-form",children:Object(ae.jsx)(Ft,{label:"Query timeout",labelWidth:13,inputEl:Object(ae.jsx)(Lt,{className:"width-6",value:a.jsonData.queryTimeout,onChange:Mt("queryTimeout",a,s),spellCheck:!1,placeholder:"60s",validationEvents:Xt}),tooltip:"Set the Prometheus query timeout."})})}),Object(ae.jsxs)("div",{className:"gf-form",children:[Ct||(Ct=Object(ae.jsx)(W.InlineFormLabel,{width:13,tooltip:"You can use either POST or GET HTTP method to query your Prometheus data source. POST is the recommended method as it allows bigger queries. Change this to GET if you have a Prometheus version older than 2.1 or if POST requests are restricted in your network.",children:"HTTP Method"})),Object(ae.jsx)(Dt,{menuShouldPortal:!0,options:Rt,value:Rt.find(e=>e.value===a.jsonData.httpMethod),onChange:Mt("httpMethod",a,s),width:7})]})]}),Tt||(Tt=Object(ae.jsx)("h3",{className:"page-heading",children:"Misc"})),Object(ae.jsxs)("div",{className:"gf-form-group",children:[Object(ae.jsx)("div",{className:"gf-form",children:Object(ae.jsx)(kt,{checked:null!==(t=a.jsonData.disableMetricsLookup)&&void 0!==t&&t,label:"Disable metrics lookup",labelClass:"width-14",onChange:Object(r.onUpdateDatasourceJsonDataOptionChecked)(e,"disableMetricsLookup"),tooltip:"Checking this option will disable the metrics chooser and metric/label support in the query field's autocomplete. This helps if you have performance issues with bigger Prometheus instances."})}),Object(ae.jsx)("div",{className:"gf-form-inline",children:Object(ae.jsx)("div",{className:"gf-form max-width-30",children:Object(ae.jsx)(Ft,{label:"Custom query parameters",labelWidth:14,tooltip:"Add Custom parameters to all Prometheus or Thanos queries.",inputEl:Object(ae.jsx)(Lt,{className:"width-25",value:a.jsonData.customQueryParameters,onChange:Mt("customQueryParameters",a,s),spellCheck:!1,placeholder:"Example: max_source_resolution=5m&timeout=10"})})})})]}),Object(ae.jsx)(Nt,{options:a.jsonData.exemplarTraceIdDestinations,onChange:e=>Object(r.updateDatasourcePluginJsonDataOption)({onOptionsChange:s,options:a},"exemplarTraceIdDestinations",e)})]})},Xt={[W.EventsWithValidation.onBlur]:[Object(W.regexValidation)(/^$|^\d+(ms|[Mwdhmsy])$/,"Value is not valid, you can use number with time unit specifier: y, M, w, d, h, m, s")]},Qt=e=>e?e.hasOwnProperty("currentTarget")?e.currentTarget.value:e.value:"",Mt=(e,t,a)=>r=>{a(Pt({},t,{jsonData:Pt({},t.jsonData,{[e]:Qt(r)})}))};function $t(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}a.d(t,"plugin",(function(){return Ut}));class Vt{constructor(){$t(this,"stepDefaultValuePlaceholder","60s")}}$t(Vt,"templateUrl","partials/annotations.editor.html");const Ut=new r.DataSourcePlugin(U).setQueryEditor(Ue).setConfigEditor(e=>{var t;const{options:a,onOptionsChange:r}=e,s={azureAuthEnabled:null!==(t=et.a.featureToggles.prometheus_azure_auth)&&void 0!==t&&t,azureSettingsUI:It};return Object(ae.jsxs)(ae.Fragment,{children:[Object(ae.jsx)(W.DataSourceHttpSettings,{defaultUrl:"http://localhost:9090",dataSourceConfig:a,showAccessOptions:!0,onChange:r,sigV4AuthToggleEnabled:et.a.sigV4AuthEnabled,azureAuthSettings:s}),Object(ae.jsx)(W.AlertingSettings,{options:a,onOptionsChange:r}),Object(ae.jsx)(At,{options:a,onOptionsChange:r})]})}).setExploreMetricsQueryField(Ze).setAnnotationQueryCtrl(Vt).setQueryEditorHelp(Ge)}}]);
//# sourceMappingURL=prometheusPlugin.62c612232a976d8836f5.js.map